YUI.add("moodle-atto_image-button",function(e,t){e.namespace("M.atto_image"),e.M.atto_image.imgWrapperTemplate='<div class="atto-image-wrapper" contenteditable="false"></div>',e.M.atto_image.imgInnerWrapperTemplate='<div class="atto-image-inner-wrapper"></div>',e.M.atto_image.imageEditableClass="atto-image-helper-editable",e.M.atto_image.resizeOverlayNodeTemplate='<div class="atto-image-resize-overlay atto_control {{classes}}"></div>',e.M.atto_image.rotateHandleTemplate='<div class="atto-image-rotate-handle-container atto_control" contenteditable="false">    <div class="atto-image-rotate-handle-vertical-line"></div>    <div class="atto-image-rotate-handle"></div></div>',e.M.atto_image.utility={parseInt10:function(e){return parseInt(e,10)},getNaturalImageSize:function(e){var t=new Image;return t.src=e,{width:t.width,height:t.height}},getNodeSize:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("width"))-e.M.atto_image.utility.getHorizontalNonContentWidth(t),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("height"))-e.M.atto_image.utility.getVerticalNonContentWidth(t);return{width:n,height:r}},getNaturalImageAspectRatio:function(e){var t=1e3;return e.width*t/(e.height*t)},getHorizontalBorderWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-left-width")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-right-width"));return n+r},getVerticalBorderWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-top-width")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-bottom-width"));return n+r},getHorizontalPaddingWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-left")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-right"));return n+r},getVerticalPaddingWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-bottom")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-top"));return n+r},getHorizontalNonContentWidth:function(e){return this.getHorizontalBorderWidth(e)+this.getHorizontalPaddingWidth(e)},getVerticalNonContentWidth:function(e){return this.getVerticalBorderWidth(e)+this.getVerticalPaddingWidth(e)},enableImageEditable:function(t){t.addClass(e.M.atto_image.imageEditableClass)},disableImageEditable:function(t){t.removeClass(e.M.atto_image.imageEditableClass)},rangyCompare:function(e,t){return e.startContainer==t.startContainer&&e.endContainer==t.endContainer&&e.startOffset==t.startOffset&&e.endOffset==t.endOffset},disableImgWrapperContentEditable:function(e){e.all(".atto-image-wrapper").each(function(e){e.getDOMNode().setAttribute("contenteditable",!1)})},disableIEImgContentEditable:function(e){e.all("img").each(function(e){e.getDOMNode().setAttribute("unselectable","on"),e.getDOMNode().setAttribute("contenteditable",!1)})},getNodeCenterClientCoord:function(e){var t=e.getDOMNode().getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}},get2DAngle:function(t,n){var r=n.x-t.x,i=n.y-t.y;return-(e.M.atto_image.utility.radToDeg(Math.atan2(r,i))-180)},degToRad:function(e){return e*(Math.PI/180)},radToDeg:function(e){return e*(180/Math.PI)},rotateNode:function(e,t){var n=e.getDOMNode();n.style.webkitTransform="rotate("+t+"deg)",n.style.mozTransform="rotate("+t+"deg)",n.style.msTransform="rotate("+t+"deg)",n.style.oTransform="rotate("+t+"deg)",n.style.transform="rotate("+t+"deg)"},getRotateNode:function(e){function t(e){var t=window.getComputedStyle(e,null),n=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"none";if(n=="none")return 0;var r=n.split("(")[1].split(")")[0].split(","),i=r[0],s=r[1],o=Math.atan2(s,i)*(180/Math.PI);return o}return t(e.getDOMNode())}},e.M.atto_image.DeleteMutationObserver=function(){e.M.atto_image.DeleteMutationObserver.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.DeleteMutationObserver,e.Base,{node:null,_mutationObserver:null,_childrenMutationObserver:null,_mutationObserverConfig:{childList:!0,subtree:!0},_deletionCallback:null,_start:!1,initializer:function(t){this.node=t.node,this._deletionCallback=t.deletionCallback,delete t.node,delete t.deletionCallback,this._mutationObserverConfig=e.merge(this._mutationObserverConfig,t)},start:function(){var e=this;this._start=!0,this._childrenMutationObserver=new MutationObserver(function(t){var n=!e.node;if(n)return;t.forEach(function(t){var n=t.removedNodes.length>0;n&&e._start&&e._deletionCallback&&e._deletionCallback(t.removedNodes)})}),this._childrenMutationObserver.observe(e.node.getDOMNode(),this._mutationObserverConfig),this._mutationObserver=new MutationObserver(function(t){var n=!e.node;if(n)return;t.forEach(function(t){var n=t.removedNodes.length>0;n&&e._start&&[].indexOf.call(t.removedNodes,e.node.getDOMNode())>=0&&e._deletionCallback&&e._deletionCallback(t.removedNodes)})}),this._mutationObserver.observe(e.node.ancestor().getDOMNode(),this._mutationObserverConfig)},stop:function(){this._start=!1,this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=null),this._childrenMutationObserver&&(this._childrenMutationObserver.disconnect(),this._childrenMutationObserver=null)}},{NAME:"atto_image_DeleteMutationObserver",isSupported:function(){var t=e.Lang.isObject(window.MutationObserver);return t}}),e.M.atto_image.EditableImg=function(){e.M.atto_image.EditableImg.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.EditableImg,e.Base,{node:null,_enable:!1,_nodeDeletionMutationObserver:null,nodeWrapper:null,initializer:function(t){this.node=t.node,this.nodeWrapper=this.node.ancestor(".atto-image-wrapper"),this.nodeInnerWrapper=this.node.ancestor(".atto-image-inner-wrapper"),this.nodeWrapper||(this.node.wrap(e.M.atto_image.imgInnerWrapperTemplate),this.nodeInnerWrapper=this.node.ancestor(".atto-image-inner-wrapper"
),this.nodeInnerWrapper.wrap(e.M.atto_image.imgWrapperTemplate),this.nodeWrapper=this.nodeInnerWrapper.ancestor(".atto-image-wrapper")),this.enable(),this._publishEvents()},enable:function(){if(this._enable)return;this._setupImgWrapper(),this._setupImgNode(),this.startDeleteMutationObserver(),this._enable=!0},disable:function(){if(!this._enable)return;this.stopDeleteMutationObserver(),this._destroyImgNode(),this._destroyImgWrapper(),this._enable=!1},startDeleteMutationObserver:function(){this._nodeDeletionMutationObserver||(this._nodeDeletionMutationObserver=new e.M.atto_image.DeleteMutationObserver({node:this.node,deletionCallback:this._onDelete.bind(this)}),this._nodeDeletionMutationObserver.start())},stopDeleteMutationObserver:function(){this._nodeDeletionMutationObserver&&(this._nodeDeletionMutationObserver.stop(),this._nodeDeletionMutationObserver=null)},getNode:function(){return this.node},getImgWrapper:function(){return this.nodeWrapper},setSize:function(e){this.node.setAttrs({width:e.width,height:e.height}),this.nodeInnerWrapper.setStyles({width:e.width,height:e.height})},setRotation:function(t){e.M.atto_image.utility.rotateNode(this.nodeInnerWrapper,t)},recalculateImgWrapper:function(){var e=this.nodeInnerWrapper.getDOMNode().getBoundingClientRect();this.nodeWrapper.setStyles({width:e.width,height:e.height}),this.nodeInnerWrapper.setStyles({left:(e.width-this.node.getAttribute("width"))/2,top:(e.height-this.node.getAttribute("height"))/2})},addControl:function(e){e.addClass("atto_control"),this.nodeInnerWrapper.appendChild(e)},_publishEvents:function(){this.publish(e.M.atto_image.EditableImg.NAME+":click",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.EditableImg.NAME+":dblclick",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.EditableImg.NAME+":init",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.EditableImg.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this)},_setupImgNode:function(){},_destroyImgNode:function(){this.node.detachAll()},_setupImgWrapper:function(){if(!this.nodeWrapper)return;var t=e.M.atto_image.utility.getRotateNode(this.nodeInnerWrapper),n={width:this.nodeWrapper.getStyle("width"),height:this.nodeWrapper.getStyle("height")};this.nodeWrapper.getDOMNode().style.cssText=this.node.getDOMNode().style.cssText,this.nodeWrapper.setStyles(n),e.M.atto_image.utility.rotateNode(this.nodeInnerWrapper,t),this.nodeWrapper.setAttribute("contenteditable",!0),this.nodeInnerWrapper.setStyles({width:this.node.getAttribute("width"),height:this.node.getAttribute("height")});var r=this.node.getComputedStyle("display")||"inline-block";r.toLowerCase()==="inline"&&(r="inline-block");var i=this.node.getComputedStyle("position")||"relative";if(i.toLowerCase()==="static"||i.toLowerCase()==="initial")i="relative";this.nodeWrapper.setStyles({display:r,position:i}),this.nodeWrapper.on("click",this._onClick,this),this.nodeWrapper.on("dblclick",this._onDblClick,this),this.nodeWrapper.get("children").each(function(e){e.on("click",this._onClick,this)},this),this.nodeWrapper.get("children").each(function(e){e.on("dblclick",this._onDblClick,this)},this),this.nodeWrapper.before("dragstart",function(e){e.halt(!0)},this),e.M.atto_image.utility.enableImageEditable(this.nodeWrapper)},_destroyImgWrapper:function(){if(!this.nodeWrapper)return;e.M.atto_image.utility.disableImageEditable(this.nodeWrapper),this.nodeWrapper.detachAll(),this.nodeWrapper.setAttribute("contenteditable",!1),this.nodeInnerWrapper.detachAll()},_onClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.EditableImg.NAME+":click",t)},_onDblClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.EditableImg.NAME+":dblclick",t)},_onDelete:function(){this.disable(),this.nodeWrapper.remove(!0),this.fire(e.M.atto_image.EditableImg.NAME+":delete")}},{NAME:"atto_image_EditableImg",isSupported:function(){var t=e.M.atto_image.DeleteMutationObserver.isSupported();return t}}),e.namespace("M.atto_image").resizable=function(){e.M.atto_image.resizable.superclass.constructor.apply(this,arguments)},e.extend(e.namespace("M.atto_image").resizable,e.Base,{node:null,_editableImg:null,_resizableOverlay:null,_resizableOverlayNode:null,_enable:!1,preserveAspectRatio:!1,initializer:function(t){this._editableImg=t.editableImg,this.node=this._editableImg.node,e.Lang.isUndefined(t.preserveAspectRatio)||(this.preserveAspectRatio=t.preserveAspectRatio),this.enable(),this._publishEvents()},enable:function(){if(this._enable)return;this._editableImg.on(e.M.atto_image.EditableImg.NAME+":click",this._onClick.bind(this)),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":dblclick",this._onDblClick.bind(this)),this._resizableOverlayNode=this._createResizeOverlayNode(),this._editableImg.addControl(this._resizableOverlayNode),this._resizableOverlay=this._createResizeOverlay(this._resizableOverlayNode,this._editableImg.node),this._editableImg.getImgWrapper().one(".yui3-resize-handles-wrapper").addClass("atto_control"),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":delete",this.deleteNode.bind(this)),this._enable=!0},disable:function(){if(!this._enable)return;this._resizableOverlay&&(this._resizableOverlay.destroy(!0),this._resizableOverlay=null),this._resizableOverlayNode&&(this._resizableOverlayNode.remove(!0),this._resizableOverlayNode=null),this._enable=!1},deleteNode:function(){this.disable(),this.node&&this.node.remove(!0),this.fire(e.M.atto_image.resizable.NAME+":delete")},getNode:function(){return this.node},getImgWrapper:function(){return this._editableImg.getImgWrapper()},_publishEvents:function(){this.publish(e.M.atto_image.resizable.NAME+":click",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":dblclick",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":resize:start",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":resize:resize",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image
.resizable.NAME+":resize:end",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":init",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.resizable.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this)},_createResizeOverlayNode:function(){var t=e.Handlebars.compile(e.M.atto_image.resizeOverlayNodeTemplate),n=e.Node.create(t({classes:""}));return n},_createResizeOverlay:function(t,n){var r=new e.Overlay({srcNode:t,width:this.node.getAttribute("width")+"px",height:this.node.getAttribute("height")+"px",visible:!0,render:!0,align:{node:n,points:["tl","tl"]}});return r.plug(e.Plugin.Resize,{handles:["t","r","b","l","tr","tl","br","bl"]}),r.resize.plug(e.Plugin.ResizeConstrained,{preserveRatio:this.preserveAspectRatio},this),r.resize.on("resize:start",function(e){this._onResizeStart(e)},this),r.resize.on("resize:resize",function(e){this._onResize(e)},this),r.resize.on("drag:end",function(e){this._onResizeEnd(e)},this),r.get("boundingBox").addClass("atto_control"),r},_onResizeStart:function(t){this._editableImg.setSize(e.M.atto_image.utility.getNodeSize(this.node)),this.fire(e.M.atto_image.resizable.NAME+":resize:start",t)},_onResize:function(t){this._resizableOverlay.align(),this.fire(e.M.atto_image.resizable.NAME+":resize:resize",t)},_onResizeEnd:function(t){this._resizableOverlay.align();var n=this._resizableOverlay.resize.info.offsetWidth,r=this._resizableOverlay.resize.info.offsetHeight,i={width:n,height:r};this._editableImg.setSize(i),this._editableImg.recalculateImgWrapper(),this._resizableOverlay.get("boundingBox").setStyles({left:"0px",top:"0px"}),this.fire(e.M.atto_image.resizable.NAME+":resize:end",t)},_onClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.resizable.NAME+":click",t)},_onDblClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.resizable.NAME+":dblclick",t)}},{NAME:"atto_image_resizable",isSupported:function(){var t=e.M.atto_image.DeleteMutationObserver.isSupported()&&e.M.atto_image.EditableImg.isSupported();return t}}),e.namespace("M.atto_image").rotatable=function(){e.M.atto_image.resizable.superclass.constructor.apply(this,arguments)},e.extend(e.namespace("M.atto_image").rotatable,e.Base,{node:null,_editableImg:null,_enable:!1,_rotateControlNode:null,_rotateControlHandleNode:null,initializer:function(e){this._editableImg=e.editableImg,this.node=this._editableImg.node,this.enable()},enable:function(){if(this._enable)return;this._editableImg.enable(),this._rotateControlNode=e.Node.create(e.M.atto_image.rotateHandleTemplate),this._rotateControlHandleNode=this._rotateControlNode.one(".atto-image-rotate-handle");var t=!1;this._rotateControlHandleNode.on(["mousedown"],function(){t=!0},this),this._rotateControlHandleNode.on(["mousemove","mousemoveoutside"],function(n){if(t){var r={x:n.clientX,y:n.clientY},i=e.M.atto_image.utility.getNodeCenterClientCoord(this._editableImg.node),s=e.M.atto_image.utility.get2DAngle(i,r);this._editableImg.setRotation(s)}},this),this._rotateControlHandleNode.on(["mouseup","mouseupoutside"],function(){t=!1,this._editableImg.recalculateImgWrapper()},this),this._editableImg.addControl(this._rotateControlNode),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":click",this._onClick.bind(this)),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":dblclick",this._onDblClick.bind(this)),this._enable=!0},disable:function(){if(!this._enable)return;this._rotateControlHandleNode&&(this._rotateControlHandleNode.remove(!0),this._rotateControlHandleNode=null),this._rotateControlNode&&(this._rotateControlNode.remove(!0),this._rotateControlNode=null),this._enable=!1},_publishEvents:function(){this.publish(e.M.atto_image.rotatable.NAME+":click",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":dblclick",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":resize:start",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":resize:resize",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":resize:end",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":init",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.rotatable.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this)},_onClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.rotatable.NAME+":click",t)},_onDblClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.rotatable.NAME+":dblclick",t)}},{NAME:"atto_image_rotatable"});var n={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry",INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box"},r={INPUTURL:"."+n.INPUTURL},i=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],s={ISPERCENT:/\d+%/},o="atto_image",u='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<div style="display:none" role="alert" class="warning {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><br/><input type="checkbox" class="{{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="sameline" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label><br/><label class="sameline" for="{{elementid}}_{{CSS.INPUTSIZE}}">{{get_string "size" component}}</label><div id="{{elementid}}_{{CSS.INPUTSIZE}}" class="{{CSS.INPUTSIZE}}"><label class="accesshide" for="{{elementid}}_{{CSS.INPUTWIDTH}}">{{get_string "width" component}}</label><input type="text" class="{{CSS.INPUTWIDTH}} input-mini" id="{{elementid}}_{{CSS.INPUTWIDTH}}" size="4"/> x <label class="accesshide" for="{{elementid}}_{{CSS.INPUTHEIGHT}}">{{get_string "height" component}}</label><input type="text" class="{{CSS.INPUTHEIGHT}} input-mini" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" size="4"/><input type="checkbox" class="{{CSS.INPUTCONSTRAIN}} sameline" id="{{elementid}}_{{CSS.INPUTCONSTRAIN}}"/><label for="{{elementid}}_{{CSS.INPUTCONSTRAIN}}">{{get_string "constrain" component}}</label></div><label class="sameline" for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="{{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}:{{name}};">{{get_string str ../component}}</option>{{/each}}</select><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>'
,a='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}unselectable="on" />';e.namespace("M.atto_image").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,_resizable:null,_rotatable:null,_editableImg:null,initializer:function(){var t=this.get("host");this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"img",tagMatchRequiresAll:!1}),e.M.atto_image.utility.disableImgWrapperContentEditable(this.editor),e.M.atto_image.utility.disableIEImgContentEditable(this.editor),this.editor.delegate("dblclick",this._displayDialogue,"img",this),this.editor.delegate("click",this._handleClick,"img",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.delegate("click",this._handleDeselect,":not(img)",this),this.editor.delegate("dragstart",function(e){e.halt(!0)},".atto-image-wrapper",this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this),t.on("atto:htmlcleaned",function(e){e.args.html=this._cleanHelperClasses(e.args.html),e.args.html=this._removeAttoControlDuringCopyAndPaste(e.args.html),e.args.html=this._removeUnwantedCleanUpElements(e.args.html),e.args.html=this._disableAttoImageWrapperContentEditable(e.args.html)},this),t.on(["atto:pastehtmlstylescleaned","atto:pastehtmlclasscleaned"],this._exemptAttoImageWrapperFromClassRemoval,this)},_cleanHelperClasses:function(e){return e.replace(/(<[^>]*?class\s*?=\s*?")([^>"]*)(")/gi,function(e,t,n,r){var i=n.replace(/(?:^|[\s])[\s]*atto-image-helper[_a-zA-Z0-9\-]*/gi,"");return t+i+r})},_removeAttoControlDuringCopyAndPaste:function(t){var n=e.Node.create(t);return n?(n.all(".atto-image-wrapper .atto_control").remove(!0),n.getHTML()):t},_removeUnwantedCleanUpElements:function(t){var n=e.Node.create(t);return n?(n.all(".atto-image-wrapper > br").remove(!0),n.all(".atto-image-inner-wrapper > br").remove(!0),n.getHTML()):t},_disableAttoImageWrapperContentEditable:function(t){var n=e.Node.create(t);return n?(n.all(".atto-image-wrapper[contenteditable=false]").setAttribute("contenteditable",!1),n.getHTML()):t},_exemptAttoImageWrapperFromClassRemoval:function(t){var n=t.args,r=n.filter(function(t){return e.one(t).ancestor(".atto-image-wrapper")});r.forEach(function(e){n.indexOf(e)>=0&&n.splice(n.indexOf(e),1)})},_handleDragDrop:function(t){var n=this,r=this.get("host"),i=e.Handlebars.compile(a);r.saveSelection(),t=t._event;var s=t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length;if(s&&/^image\//.test(t.dataTransfer.files[0].type)){var u=r.get("filepickeroptions").image,f=u.savepath===undefined?"/":u.savepath,l=new FormData,c=0,h="",p=new XMLHttpRequest,d="",v=Object.keys(u.repositories);t.preventDefault(),t.stopPropagation(),l.append("repo_upload_file",t.dataTransfer.files[0]),l.append("itemid",u.itemid);for(var m=0;m<v.length;m++)if(u.repositories[v[m]].type==="upload"){l.append("repo_id",u.repositories[v[m]].id);break}return l.append("env",u.env),l.append("sesskey",M.cfg.sesskey),l.append("client_id",u.client_id),l.append("savepath",f),l.append("ctx_id",u.context.id),c=(new Date).getTime(),h="moodleimage_"+Math.round(Math.random()*1e5)+"-"+c,r.focus(),r.restoreSelection(),d=i({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",o),id:h}),r.insertContentAtFocusPoint(d),n.markUpdated(),p.onreadystatechange=function(){var t=n.editor.one("#"+h),r,s,o,u;if(p.readyState===4)if(p.status===200){r=JSON.parse(p.responseText);if(r){if(r.error)return t&&t.remove(!0),new M.core.ajaxException(r);s=r,r.event&&r.event==="fileexists"&&(s=r.newfile),o=i({url:s.url,presentation:!0}),u=e.Node.create(o),t?t.replace(u):n.editor.appendChild(u),n.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),t&&t.remove(!0)},p.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),p.send(l),!1}},_handleClick:function(e){var t=e.target;this._initEditableImg(t),e.halt(!0)},_initEditableImg:function(t){var n=this,r=this._editableImg&&this._editableImg.node.getDOMNode()===t.getDOMNode();if(r)return;var i=this._editableImg&&this._editableImg.node.getDOMNode()!==t.getDOMNode();i&&this._destroyEditableImg(),this._editableImg=new e.M.atto_image.EditableImg({node:t,after:{init:function(){this.on("atto_image_EditableImg:init",n._editableImgInitHandler,n),this.fire("atto_image_EditableImg:init")}}})},_destroyEditableImg:function(){this._editableImg&&(window.rangy.getSelection().removeAllRanges(),this._editableImg.disable(),this._editableImg=null,this._destroyRotatable(this._rotatable),this._destroyResizable(this._resizable))},_editableImgInitHandler:function(e){var t=e.target,n=this.get("host").getSelectionFromNode(t.nodeWrapper);this.get("host").getSelection()!==n&&this.get("host").setSelection(n),this._initResizable(t),this._initRotatable(t)},_handleDeselect:function(){this._editableImg&&(this._destroyEditableImg(),this._editableImg=null)},_resizableInitHandler:function(t){var n=t.currentTarget;if(n!==this._resizable){this._handleDeselect(),this._resizable=n,this._resizable.enable(),window.rangy.getSelection().removeAllRanges();var r=null,i=e.UA.gecko>0;if(i){this._resizable.getImgWrapper().insert('<span class="atto_control">',"before"),this._resizable.getImgWrapper().insert('<span class="atto_control">',"after");var s=window.rangy.createRange();s.setStartBefore(this._resizable.getImgWrapper().getDOMNode()),s.setEndAfter(this._resizable.getImgWrapper().getDOMNode()),s.setStart(s.startContainer,s.startOffset-1),s.setEnd(s.endContainer,s.endOffset+1),r=[s]}else r=this.get("host").getSelectionFromNode(this._resizable.getImgWrapper
());this.get("host").setSelection(r)}},_resizableDeleteHandler:function(e){var t=e.target;this._destroyResizable(t)},_resizableResizeStartHandler:function(e){var t=e.target;t.node.removeClass(n.RESPONSIVE)},_initResizable:function(t){var n=this;if(!e.M.atto_image.resizable.isSupported())return;var r={editableImg:t,after:{init:function(){this.on("atto_image_resizable:init",n._resizableInitHandler,n),this.fire("atto_image_resizable:init")}}};this._resizable=new e.M.atto_image.resizable(r),this._resizable.on("atto_image_resizable:resize:start",this._resizableResizeStartHandler,this),this._resizable.on("atto_image_resizable:dblclick",this._displayDialogueWhileResizing,this),this._resizable.on("atto_image_resizable:delete",this._resizableDeleteHandler,this)},_destroyResizable:function(e){e==this._resizable&&(this._resizable=null),e&&e.disable()},_initRotatable:function(t){var n={editableImg:t,after:{init:function(){this.fire("atto_image_rotatable:init")}}};this._rotatable=new e.M.atto_image.rotatable(n)},_destroyRotatable:function(e){e==this._rotatable&&(this._rotatable=null),e&&e.disable()},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("imageproperties",o),width:"480px",focusAfterHide:!0,focusOnShowSelector:r.INPUTURL});e.set("bodyContent",this._getDialogueContent()).show()},_displayDialogueWhileResizing:function(e){var t=e.resizable;if(t){var n=t.node;this._destroyResizable(t);var r=this.get("host").getSelectionFromNode(n);this.get("host").setSelection(r),this._currentSelection=this.get("host").getSelection()}this._displayDialogue(),e.stopImmediatePropagation()},_loadPreviewImage:function(e){var t=new Image,r=this;t.onerror=function(){var e=r._form.one("."+n.IMAGEPREVIEW);e.setStyles({display:"none"}),r.getDialogue().centerDialogue()},t.onload=function(){var e,t,i,o,u;r._rawImageDimensions={width:this.width,height:this.height},e=r._form.one("."+n.INPUTWIDTH),t=e.get("value"),t===""&&(e.set("value",this.width),t=""+this.width),e=r._form.one("."+n.INPUTHEIGHT),i=e.get("value"),i===""&&(e.set("value",this.height),i=""+this.height),e=r._form.one("."+n.IMAGEPREVIEW),e.setAttribute("src",this.src),e.setStyles({display:"inline"}),e=r._form.one("."+n.INPUTCONSTRAIN),t.match(s.ISPERCENT)&&i.match(s.ISPERCENT)?e.set("checked",t===i):(this.width===0&&(this.width=1),this.height===0&&(this.height=1),o=Math.round(1e3*parseInt(t,10)/this.width),u=Math.round(1e3*parseInt(i,10)/this.height),e.set("checked",o===u)),r._autoAdjustSize(r),r.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var t=e.Handlebars.compile(u),r=this.get("host").canShowFilepicker("image"),s=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:n,component:o,showFilepicker:r,alignments:i}));return this._form=s,this._applyImageProperties(this._form),this._form.one("."+n.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+n.IMAGEPRESENTATION).on("change",this._updateWarning,this),this._form.one("."+n.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+n.INPUTWIDTH).on("blur",this._autoAdjustSize,this),this._form.one("."+n.INPUTHEIGHT).on("blur",this._autoAdjustSize,this,!0),this._form.one("."+n.INPUTCONSTRAIN).on("change",function(e){e.target.get("checked")&&this._autoAdjustSize(e)},this),this._form.one("."+n.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+n.INPUTSUBMIT).on("click",this._setImage,this),r&&this._form.one("."+n.IMAGEBROWSER).on("click",function(){this.get("host").showFilepicker("image",this._filepickerCallback,this)},this),s},_autoAdjustSize:function(e,t){t=t||!1;var r=this._form.one("."+n.INPUTWIDTH),i="width",o=this._form.one("."+n.INPUTHEIGHT),u="height",a=this._form.one("."+n.INPUTCONSTRAIN),f=r.get("value"),l=o.get("value"),c=this._form.one("."+n.IMAGEPREVIEW),h,p;if(!this._rawImageDimensions)return;f===""&&(f=this._rawImageDimensions[i],r.set("value",f),f=r.get("value")),c.setStyles({width:null,height:null});if(!a.get("checked"))f.match(s.ISPERCENT)?(h=parseInt(f,10),p=this._rawImageDimensions.width/100*h,c.setStyle("width",p+"px")):c.setStyle("width",f+"px"),l.match(s.ISPERCENT)?(h=parseInt(l,10),p=this._rawImageDimensions.height/100*h,c.setStyle("height",p+"px")):c.setStyle("height",l+"px");else{if(t){var d;d=r,r=o,o=d,d=i,i=u,u=d,d=f,f=l,l=d}f.match(s.ISPERCENT)?(l=f,h=parseInt(f,10),p=this._rawImageDimensions.width/100*h,c.setStyle("width",p),p=this._rawImageDimensions.height/100*h,c.setStyle("height",p)):(l=Math.round(f/this._rawImageDimensions[i]*this._rawImageDimensions[u]),t?c.setStyles({width:l,height:f}):c.setStyles({width:f,height:l})),o.set("value",l)}},_filepickerCallback:function(e){if(e.url!==""){var t=this._form.one("."+n.INPUTURL);t.set("value",e.url),this._form.one("."+n.INPUTWIDTH).set("value",""),this._form.one("."+n.INPUTHEIGHT).set("value",""),this._loadPreviewImage(e.url)}},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),r=e.one("."+n.IMAGEPREVIEW),s,o;if(t===!1){r.setStyle("display","none");for(s in i)i[s].isDefault===!0&&(o=i[s].value+":"+i[s].name+";",e.one("."+n.INPUTALIGNMENT).set("value",o));e.one("."+n.INPUTALIGNMENT).getDOMNode().options.remove(i.length-1);return}t.align?(e.one("."+n.INPUTALIGNMENT).set("value",t.align),e.one("."+n.INPUTALIGNMENT).getDOMNode().options.remove(i.length-1)):e.one("."+n.INPUTALIGNMENT).set("value","style:customstyle;"),t.customstyle&&e.one("."+n.INPUTCUSTOMSTYLE).set("value",t.customstyle),t.width&&e.one("."+n.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+n.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+n.INPUTALT).set("value",t.alt),t.src&&(e.one("."+n.INPUTURL).set("value",t.src),this._loadPreviewImage(t.src)),t.presentation&&e.one("."+n.IMAGEPRESENTATION).set("checked","checked"),this._autoAdjustSize()},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null,
align:"",presentation:!1},t=this.get("host").getSelectedNodes(),n,r,o,u,a,f,l;t&&(t=t.filter("img"));if(t&&t.size()){f=t.item(0),this._selectedImage=f,u=f.getAttribute("style"),e.customstyle=u,u=u.replace(/ /g,""),r=f.getAttribute("width"),r.match(s.ISPERCENT)||(r=parseInt(r,10)),o=f.getAttribute("height"),o.match(s.ISPERCENT)||(o=parseInt(o,10)),r!==0&&(e.width=r),o!==0&&(e.height=o);for(n in i){a=i[n].value+":"+i[n].name+";";if(u.indexOf(a)!==-1){l="margin:"+i[n].margin+";",l=l.replace(/ /g,"");if(u.indexOf(l)!==-1){e.align=a;break}}}return e.src=f.getAttribute("src"),e.alt=f.getAttribute("alt")||"",e.presentation=f.get("role")==="presentation",e}return this._selectedImage=null,!1},_urlChanged:function(){var e=this._form.one("."+n.INPUTURL);e.get("value")!==""&&this._loadPreviewImage(e.get("value"))},_setImage:function(t){var r=this._form,o=r.one("."+n.INPUTURL).get("value"),u=r.one("."+n.INPUTALT).get("value"),f=r.one("."+n.INPUTWIDTH).get("value"),l=r.one("."+n.INPUTHEIGHT).get("value"),c=r.one("."+n.INPUTALIGNMENT).get("value"),h="",p=r.one("."+n.IMAGEPRESENTATION).get("checked"),d=r.one("."+n.INPUTCONSTRAIN).get("checked"),v,m="",g,y,b=[],w=this.get("host");t.preventDefault();if(this._updateWarning())return;w.focus();if(o!==""){this._selectedImage?w.setSelection(w.getSelectionFromNode(this._selectedImage)):w.setSelection(this._currentSelection);if(c==="style:customstyle;")c="",m=r.one("."+n.INPUTCUSTOMSTYLE).get("value");else for(g in i)y=i[g].value+":"+i[g].name+";",c===y&&(h=" margin: "+i[g].margin+";");d&&b.push(n.RESPONSIVE);if(!f.match(s.ISPERCENT)&&isNaN(parseInt(f,10))){r.one("."+n.INPUTWIDTH).focus();return}if(!l.match(s.ISPERCENT)&&isNaN(parseInt(l,10))){r.one("."+n.INPUTHEIGHT).focus();return}var E=e.Handlebars.compile(a);v=E({url:o,alt:u,width:f,height:l,presentation:p,alignment:c,margin:h,customstyle:m,classlist:b.join(" ")}),this.get("host").insertContentAtFocusPoint(v),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()},_updateWarning:function(){var e=this._form,t=!0,r=e.one("."+n.INPUTALT).get("value"),i=e.one("."+n.IMAGEPRESENTATION).get("checked");return r===""&&!i?(e.one("."+n.IMAGEALTWARNING).setStyle("display","block"),e.one("."+n.INPUTALT).setAttribute("aria-invalid",!0),e.one("."+n.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),t=!0):(e.one("."+n.IMAGEALTWARNING).setStyle("display","none"),e.one("."+n.INPUTALT).setAttribute("aria-invalid",!1),e.one("."+n.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),t=!1),this.getDialogue().centerDialogue(),t}})},"@VERSION@",{requires:["moodle-editor_atto-rangy","moodle-editor_atto-plugin","resize","resize-plugin"]});
