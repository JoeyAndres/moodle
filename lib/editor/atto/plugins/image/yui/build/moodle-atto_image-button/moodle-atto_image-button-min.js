YUI.add("moodle-atto_image-button",function(e,t){e.namespace("M.atto_image"),e.M.atto_image.imgWrapperTemplate='<div class="atto-image-wrapper" contenteditable="false">   {{#if content}}{{content}}{{/if}}</div>',e.M.atto_image.imageEditableClass="atto-image-helper-editable",e.M.atto_image.resizeOverlayNodeTemplate='<div class="atto-image-resize-overlay atto_control {{classes}}"></div>',e.M.atto_image.rotateHandleTemplate='<div class="atto-image-rotate-handle-container atto_control" contenteditable="false">    <div class="atto-image-rotate-handle-vertical-line"></div>    <div class="atto-image-rotate-handle"></div></div>',e.M.atto_image.utility={parseInt10:function(e){return parseInt(e,10)},getNaturalImageSize:function(e){var t=new Image;return t.src=e,{width:t.width,height:t.height}},getNodeSize:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("width"))-e.M.atto_image.utility.getHorizontalNonContentWidth(t),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("height"))-e.M.atto_image.utility.getVerticalNonContentWidth(t);return{width:n,height:r}},getNaturalImageAspectRatio:function(e){var t=1e3;return e.width*t/(e.height*t)},getHorizontalBorderWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-left-width")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-right-width"));return n+r},getVerticalBorderWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-top-width")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-bottom-width"));return n+r},getHorizontalPaddingWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-left")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-right"));return n+r},getVerticalPaddingWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-bottom")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-top"));return n+r},getHorizontalNonContentWidth:function(e){return this.getHorizontalBorderWidth(e)+this.getHorizontalPaddingWidth(e)},getVerticalNonContentWidth:function(e){return this.getVerticalBorderWidth(e)+this.getVerticalPaddingWidth(e)},rangyCompare:function(e,t){return e.startContainer==t.startContainer&&e.endContainer==t.endContainer&&e.startOffset==t.startOffset&&e.endOffset==t.endOffset},disableContentEditable:function(e){e.all(".atto-image-wrapper").each(function(e){e.getDOMNode().setAttribute("contenteditable",!1)}),e.all("img").each(function(e){e.getDOMNode().setAttribute("unselectable","on")})},getNodeCenterClientCoord:function(e){var t=e.getDOMNode().getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}},get2DAngle:function(t,n){var r=n.x-t.x,i=n.y-t.y;return-(e.M.atto_image.utility.radToDeg(Math.atan2(r,i))-180)},degToRad:function(e){return e*(Math.PI/180)},radToDeg:function(e){return e*(180/Math.PI)},rotateNode:function(e,t){var n=e.getDOMNode();n.style.webkitTransform="rotate("+t+"deg)",n.style.mozTransform="rotate("+t+"deg)",n.style.msTransform="rotate("+t+"deg)",n.style.oTransform="rotate("+t+"deg)",n.style.transform="rotate("+t+"deg)"},getRotateNode:function(e){function t(e){var t=window.getComputedStyle(e,null),n=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"none";if(n=="none")return 0;var r=n.split("(")[1].split(")")[0].split(","),i=r[0],s=r[1],o=Math.atan2(s,i)*(180/Math.PI);return o<0&&(o+=360),o}return t(e.getDOMNode())}},e.M.atto_image.DeleteMutationObserver=function(){e.M.atto_image.DeleteMutationObserver.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.DeleteMutationObserver,e.Base,{node:null,_mutationObserver:null,_childrenMutationObserver:null,_mutationObserverConfig:{childList:!0,subtree:!0},_deletionCallback:null,_start:!1,initializer:function(t){this.node=t.node,this._deletionCallback=t.deletionCallback,delete t.node,delete t.deletionCallback,this._mutationObserverConfig=e.merge(this._mutationObserverConfig,t)},destructor:function(){this.detachAll(),this.stop()},start:function(){this._start=!0,this._childrenMutationObserver=new MutationObserver(function(e){var t=!this.node;if(t)return;e.forEach(function(e){var t=e.removedNodes.length>0;t&&this._start&&this._deletionCallback&&this._deletionCallback(e.removedNodes)})}.bind(this)),this._childrenMutationObserver.observe(this.node.getDOMNode(),this._mutationObserverConfig),this._mutationObserver=new MutationObserver(function(e){var t=!this.node;if(t)return;e.forEach(function(e){var t=e.removedNodes.length>0;t&&this._start&&[].indexOf.call(e.removedNodes,this.node.getDOMNode())>=0&&this._deletionCallback&&this._deletionCallback(e.removedNodes)})}.bind(this)),this._mutationObserver.observe(this.node.ancestor().getDOMNode(),this._mutationObserverConfig)},stop:function(){this._start=!1,this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=null),this._childrenMutationObserver&&(this._childrenMutationObserver.disconnect(),this._childrenMutationObserver=null)}},{NAME:"atto_image_DeleteMutationObserver",isSupported:function(){var t=e.Lang.isObject(window.MutationObserver);return t}});var n="t",r="tr",i="r",s="br",o="b",u="bl",a="l",f="tl";e.M.atto_image.EditableImg=function(){e.M.atto_image.EditableImg.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.EditableImg,e.Base,{node:null,host:null,_enable:!1,_nodeDeletionMutationObserver:null,_orientation:n,nodeWrapper:null,initializer:function(t){this.node=t.node,this.nodeWrapper=this.node.ancestor(".atto-image-wrapper"),this.nodeWrapper||(this.node.wrap(e.Handlebars.compile(e.M.atto_image.imgWrapperTemplate)({content:""})),this.nodeWrapper=this.node.ancestor(".atto-image-wrapper")),this.host=t.host,this.enable(),this._publishEvents()},destructor:function(){this.detachAll(),this.disable()},enable:function(){if(this._enable)return;
this._setupImgWrapper(),this._setupImgNode(),this.startDeleteMutationObserver(),this._enable=!0},disable:function(){if(!this._enable)return;this.stopDeleteMutationObserver(),this._destroyImgNode(),this._destroyImgWrapper(),this._enable=!1},startDeleteMutationObserver:function(){this._nodeDeletionMutationObserver||(this._nodeDeletionMutationObserver=new e.M.atto_image.DeleteMutationObserver({node:this.node,deletionCallback:this._onDelete.bind(this)}),this._nodeDeletionMutationObserver.start())},stopDeleteMutationObserver:function(){this._nodeDeletionMutationObserver&&(this._nodeDeletionMutationObserver.stop(),this._nodeDeletionMutationObserver=null)},getNode:function(){return this.node},getImgWrapper:function(){return this.nodeWrapper},getOrientation:function(){return this._orientation},setSize:function(t){this.node.setAttrs({width:t.width,height:t.height}),this.nodeWrapper.setStyles({width:t.width,height:t.height}),this.fire(e.M.atto_image.EditableImg.NAME+":transform")},getRotation:function(){return e.M.atto_image.utility.getRotateNode(this.node)},setRotation:function(t){e.M.atto_image.utility.rotateNode(this.node,t),this.nodeWrapper.get("children").each(function(n){n.hasClass("atto_control")&&e.M.atto_image.utility.rotateNode(n,t)}),this._updateOrientation(),this.fire(e.M.atto_image.EditableImg.NAME+":transform")},recalculateImgWrapper:function(){var t=this.node.getDOMNode().getBoundingClientRect();this._updateOrientation(),this.nodeWrapper.setStyles({width:t.width,height:t.height}),this._removeOrientationClasses(this.nodeWrapper),this.nodeWrapper.addClass("atto-image-helper-orientation-"+this._orientation),this.node.setStyles({left:(t.width-this.node.getAttribute("width"))/2,top:(t.height-this.node.getAttribute("height"))/2}),this.nodeWrapper.get("children").each(function(e){e.hasClass("atto_control")&&e.setStyles({left:(t.width-this.node.getAttribute("width"))/2,top:(t.height-this.node.getAttribute("height"))/2})},this),this.fire(e.M.atto_image.EditableImg.NAME+":recalculated"),this.select()},select:function(){window.rangy.getSelection().removeAllRanges();var e=this.getSelection();this.host.setSelection(e)},getSelection:function(){var t=null,n=e.UA.gecko>0;if(n){this.nodeWrapper.insert('<span class="atto_control">',"before"),this.nodeWrapper.insert('<span class="atto_control">',"after");var r=window.rangy.createRange();r.setStartBefore(this.nodeWrapper.getDOMNode()),r.setEndAfter(this.nodeWrapper.getDOMNode()),r.setStart(r.startContainer,r.startOffset-1),r.setEnd(r.endContainer,r.endOffset+1),t=[r]}else t=this.host.getSelectionFromNode(this.nodeWrapper);return t},addControl:function(t){t.addClass("atto_control"),e.M.atto_image.utility.rotateNode(t,this.getRotation()),this.nodeWrapper.appendChild(t)},_publishEvents:function(){this.publish(e.M.atto_image.EditableImg.NAME+":click",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.EditableImg.NAME+":dblclick",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.EditableImg.NAME+":init",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.EditableImg.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.EditableImg.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.EditableImg.NAME+":transform",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.EditableImg.NAME+":recalculated",{emitFacade:!0,broadcast:2,context:this},this)},_setupImgNode:function(){},_destroyImgNode:function(){this.node.detachAll()},_enableImageEditable:function(t){t.addClass(e.M.atto_image.imageEditableClass)},_disableImageEditable:function(t){t.removeClass(e.M.atto_image.imageEditableClass)},_setupImgWrapper:function(){if(!this.nodeWrapper)return;this.nodeWrapper.getDOMNode().style.cssText=this.node.getDOMNode().style.cssText,this.nodeWrapper.setAttribute("contenteditable",!0),this.nodeWrapper.setStyles({width:this.node.getAttribute("width"),height:this.node.getAttribute("height")});var e=this.node.getComputedStyle("display")||"inline-block";e.toLowerCase()==="inline"&&(e="inline-block");var t=this.node.getComputedStyle("position")||"relative";if(t.toLowerCase()==="static"||t.toLowerCase()==="initial")t="relative";this.nodeWrapper.setStyles({display:e,position:t}),this.nodeWrapper.on("click",this._onClick,this),this.nodeWrapper.on("dblclick",this._onDblClick,this),this.nodeWrapper.get("children").each(function(e){e.on("click",this._onClick,this)},this),this.nodeWrapper.get("children").each(function(e){e.on("dblclick",this._onDblClick,this)},this),this.nodeWrapper.before("dragstart",function(e){e.halt(!0)},this),this._enableImageEditable(this.nodeWrapper)},_destroyImgWrapper:function(){if(!this.nodeWrapper)return;this._disableImageEditable(this.nodeWrapper),this._removeOrientationClasses(this.nodeWrapper),this.nodeWrapper.detachAll(),this.nodeWrapper.setAttribute("contenteditable",!1)},_onClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.EditableImg.NAME+":click",t),this.select()},_onDblClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.EditableImg.NAME+":dblclick",t),this.select()},_onDelete:function(){this.disable(),this.nodeWrapper.remove(!0),this.fire(e.M.atto_image.EditableImg.NAME+":delete")},_updateOrientation:function(){var e=this.getRotation(),t=e>=330&&e<=360||e>=0&&e<30,l=e>=30&&e<60,c=e>=60&&e<120,h=e>=120&&e<150,p=e>=150&&e<210,d=e>=210&&e<240,v=e>=240&&e<300,m=e>=300&&e<330;t?this._orientation=n:l?this._orientation=f:v?this._orientation=i:h?this._orientation=u:p?this._orientation=o:d?this._orientation=s:c?this._orientation=a:m&&(this._orientation=r)},_removeOrientationClasses:function(e){e.removeClass("atto-image-helper-orientation-t"),e.removeClass("atto-image-helper-orientation-tl"),e.removeClass("atto-image-helper-orientation-r"),e.removeClass("atto-image-helper-orientation-bl"),e.removeClass("atto-image-helper-orientation-b"),e.removeClass("atto-image-helper-orientation-br"),e.removeClass("atto-image-helper-orientation-l"
),e.removeClass("atto-image-helper-orientation-tr")}},{NAME:"atto_image_EditableImg",isSupported:function(){var t=e.M.atto_image.DeleteMutationObserver.isSupported();return t}}),e.M.atto_image.resizable=function(){e.M.atto_image.resizable.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.resizable,e.Base,{node:null,_editableImg:null,_resizableOverlay:null,_resizableOverlayNode:null,_enable:!1,preserveAspectRatio:!1,initializer:function(t){this._editableImg=t.editableImg,this.node=this._editableImg.node,e.Lang.isUndefined(t.preserveAspectRatio)||(this.preserveAspectRatio=t.preserveAspectRatio),this.enable(),this._publishEvents()},destructor:function(){this.detachAll(),this.disable()},enable:function(){if(this._enable)return;this._editableImg.on(e.M.atto_image.EditableImg.NAME+":click",this._onClick.bind(this)),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":dblclick",this._onDblClick.bind(this)),this._resizableOverlayNode=this._createResizeOverlayNode(),this._editableImg.addControl(this._resizableOverlayNode,!1),e.M.atto_image.utility.rotateNode(this._resizableOverlayNode,0),this._resizableOverlay=this._createResizeOverlay(this._resizableOverlayNode,this._editableImg.node),e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),this._editableImg.getRotation()),this._editableImg.getImgWrapper().one(".yui3-resize-handles-wrapper").addClass("atto_control"),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":delete",this.deleteNode.bind(this)),this._editableImg.on([e.M.atto_image.EditableImg.NAME+":recalculated",e.M.atto_image.EditableImg.NAME+":transform"],this._onEditableImgRecalculated,this),this._enable=!0},disable:function(){if(!this._enable)return;this._resizableOverlay&&(this._resizableOverlay.destroy(!0),this._resizableOverlay=null),this._resizableOverlayNode&&(this._resizableOverlayNode.remove(!0),this._resizableOverlayNode=null),this._enable=!1},deleteNode:function(){this.disable(),this.node&&this.node.remove(!0),this.fire(e.M.atto_image.resizable.NAME+":delete")},getNode:function(){return this.node},getImgWrapper:function(){return this._editableImg.getImgWrapper()},_publishEvents:function(){this.publish(e.M.atto_image.resizable.NAME+":click",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":dblclick",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":resize:start",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":resize:resize",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":resize:end",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.resizable.NAME+":init",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.resizable.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this)},_createResizeOverlayNode:function(){var t=e.Handlebars.compile(e.M.atto_image.resizeOverlayNodeTemplate);return e.Node.create(t({classes:""}))},_createResizeOverlay:function(t,n){var r=new e.Overlay({srcNode:t,visible:!0,render:!0,align:{node:n,points:["tl","tl"]}});return this._setResizeOverlaySize(r),r.plug(e.Plugin.Resize,{handles:["t","r","b","l","tr","tl","br","bl"]}),r.resize.plug(e.Plugin.ResizeConstrained,{preserveRatio:this.preserveAspectRatio},this),r.resize.on("resize:start",this._onResizeStart,this),r.resize.on("resize:resize",this._onResize,this),r.resize.on("drag:end",this._onResizeEnd,this),r.get("boundingBox").addClass("atto_control"),r},_onResizeStart:function(t){this.fire(e.M.atto_image.resizable.NAME+":resize:start",t)},_onResize:function(t){this._resizableOverlay.align(),this.fire(e.M.atto_image.resizable.NAME+":resize:resize",t)},_onResizeEnd:function(t){this._resizableOverlay.align(),this._editableImg.setSize(this._getResizeOverlaySize()),this._editableImg.recalculateImgWrapper(),this.fire(e.M.atto_image.resizable.NAME+":resize:end",t)},_onClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.resizable.NAME+":click",t)},_onDblClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.resizable.NAME+":dblclick",t)},_onEditableImgRecalculated:function(){var t=this._editableImg.getRotation(),n=this._editableImg.getOrientation();n==i?e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t+90):n==o||n==s||n==u?e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t+180):n==a&&e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t+270),this._setResizeOverlaySize(),this._resizableOverlay.align()},_getResizeOverlaySize:function(){var e=this._resizableOverlay.resize.info.offsetWidth,t=this._resizableOverlay.resize.info.offsetHeight,n={width:e,height:t},r=this._editableImg.getOrientation();if(r==a||r==i)n={width:t,height:e};return n},_setResizeOverlaySize:function(e){e=e||this._resizableOverlay;var t=this.node.getAttribute("width")+"px",n=this.node.getAttribute("height")+"px",r={width:t,height:n},s=this._editableImg.getOrientation();if(s==a||s==i)r={width:n,height:t};e.get("boundingBox").setStyles(r)}},{NAME:"atto_image_resizable",isSupported:function(){var t=e.M.atto_image.DeleteMutationObserver.isSupported()&&e.M.atto_image.EditableImg.isSupported();return t}}),e.namespace("M.atto_image").rotatable=function(){e.M.atto_image.resizable.superclass.constructor.apply(this,arguments)},e.extend(e.namespace("M.atto_image").rotatable,e.Base,{node:null,_editableImg:null,_enable:!1,_rotateControlNode:null,_rotateControlHandleNode:null,initializer:function(e){this._editableImg=e.editableImg,this.node=this._editableImg.node,this.enable()},destructor:function(){this.detachAll(),this.disable()},enable:function(){if(this._enable)return;this._rotateControlNode=e.Node.create(e.M.atto_image.rotateHandleTemplate),this._rotateControlHandleNode=this._rotateControlNode.one(".atto-image-rotate-handle");var t=!1;this._rotateControlHandleNode.on(["mousedown"],function(e){t=!0,this._onRotateStart(e)},this),this._rotateControlHandleNode.on(["mousemove"
,"mousemoveoutside"],function(e){t&&this._onRotate(e)},this),this._rotateControlHandleNode.on(["mouseup","mouseupoutside"],function(e){t&&this._onRotateEnd(e),t=!1},this),this._editableImg.addControl(this._rotateControlNode),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":click",this._onClick.bind(this)),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":dblclick",this._onDblClick.bind(this)),this._editableImg.on(e.M.atto_image.EditableImg.NAME+":recalculated",this._onEditableImgRecalculated,this),this._enable=!0},disable:function(){if(!this._enable)return;this._rotateControlHandleNode&&(this._rotateControlHandleNode.remove(!0),this._rotateControlHandleNode=null),this._rotateControlNode&&(this._rotateControlNode.remove(!0),this._rotateControlNode=null),this._enable=!1},_publishEvents:function(){this.publish(e.M.atto_image.rotatable.NAME+":click",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":dblclick",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":rotate:start",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":rotate:rotate",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":rotate:end",{emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":init",{emitFacade:!0,broadcast:2,context:this},this),this.publish(e.M.atto_image.rotatable.NAME+":delete",{emitFacade:!0,broadcast:2,context:this},this)},_onClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.rotatable.NAME+":click",t)},_onDblClick:function(t){t.stopPropagation(),this.fire(e.M.atto_image.rotatable.NAME+":dblclick",t)},_onRotateStart:function(){this.fire(e.M.atto_image.rotatable.NAME+":rotate:start")},_onRotate:function(t){var n={x:t.clientX,y:t.clientY},r=e.M.atto_image.utility.getNodeCenterClientCoord(this._editableImg.node),i=e.M.atto_image.utility.get2DAngle(r,n);this._editableImg.setRotation(i),this.fire(e.M.atto_image.rotatable.NAME+":rotate:rotate")},_onRotateEnd:function(){this._editableImg.recalculateImgWrapper(),this.fire(e.M.atto_image.rotatable.NAME+":rotate:end")},_onEditableImgRecalculated:function(){this._rotateControlNode.setStyles({width:this._editableImg.node.getAttribute("width"),height:this._editableImg.node.getAttribute("height")})}},{NAME:"atto_image_rotatable"});var l={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry",INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box"},c={INPUTURL:"."+l.INPUTURL},h=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],p={ISPERCENT:/\d+%/},d="atto_image",v='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<div style="display:none" role="alert" class="warning {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><br/><input type="checkbox" class="{{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="sameline" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label><br/><label class="sameline" for="{{elementid}}_{{CSS.INPUTSIZE}}">{{get_string "size" component}}</label><div id="{{elementid}}_{{CSS.INPUTSIZE}}" class="{{CSS.INPUTSIZE}}"><label class="accesshide" for="{{elementid}}_{{CSS.INPUTWIDTH}}">{{get_string "width" component}}</label><input type="text" class="{{CSS.INPUTWIDTH}} input-mini" id="{{elementid}}_{{CSS.INPUTWIDTH}}" size="4"/> x <label class="accesshide" for="{{elementid}}_{{CSS.INPUTHEIGHT}}">{{get_string "height" component}}</label><input type="text" class="{{CSS.INPUTHEIGHT}} input-mini" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" size="4"/><input type="checkbox" class="{{CSS.INPUTCONSTRAIN}} sameline" id="{{elementid}}_{{CSS.INPUTCONSTRAIN}}"/><label for="{{elementid}}_{{CSS.INPUTCONSTRAIN}}">{{get_string "constrain" component}}</label></div><label class="sameline" for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="{{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}:{{name}};">{{get_string str ../component}}</option>{{/each}}</select><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>',m='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}unselectable="on" />'
;e.namespace("M.atto_image").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,_resizable:null,_rotatable:null,_editableImg:null,initializer:function(){var t=this.get("host");this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"img",tagMatchRequiresAll:!1}),e.M.atto_image.utility.disableContentEditable(this.editor),this.editor.delegate("dblclick",this._displayDialogue,"img",this),this.editor.delegate("click",this._handleClick,"img",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.delegate("click",this._handleDeselect,":not(img)",this),this.editor.delegate("dragstart",function(e){e.halt(!0)},".atto-image-wrapper",this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this),t.on("atto:htmlcleaned",this._handleHtmlClean,this),t.on(["atto:pastehtmlstylescleaned","atto:pastehtmlclasscleaned"],this._handleClassClean,this)},_handleHtmlClean:function(t){var n=t.args.html,r=!n;if(r){t.args.html="";return}n=n.replace(/(<[^>]*?class\s*?=\s*?")([^>"]*)(")/gi,function(e,t,n,r){var i=n.replace(/(?:^|[\s])[\s]*atto-image-helper[_a-zA-Z0-9\-]*/gi,"");return t+i+r});var i=document.createElement("div");i.innerHTML=n;var s=e.one(i);if(!s){t.args.html=n||"";return}s.all(".atto-image-wrapper .atto_control").remove(!0),s.all(".atto-image-wrapper > br").remove(!0),s.all(".atto-image-wrapper[contenteditable=true]").setAttribute("contenteditable",!1),n=s.getHTML(),t.args.html=n},_handleClassClean:function(t){var n=t.args,r=n.filter(function(t){return e.one(t).ancestor(".atto-image-wrapper",!0)});r.forEach(function(e){n.indexOf(e)>=0&&n.splice(n.indexOf(e),1)})},_handleDragDrop:function(t){var n=this,r=this.get("host"),i=e.Handlebars.compile(m);r.saveSelection(),t=t._event;var s=t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length;if(s&&/^image\//.test(t.dataTransfer.files[0].type)){var o=r.get("filepickeroptions").image,u=o.savepath===undefined?"/":o.savepath,a=new FormData,f=0,l="",c=new XMLHttpRequest,h="",p=Object.keys(o.repositories);t.preventDefault(),t.stopPropagation(),a.append("repo_upload_file",t.dataTransfer.files[0]),a.append("itemid",o.itemid);for(var v=0;v<p.length;v++)if(o.repositories[p[v]].type==="upload"){a.append("repo_id",o.repositories[p[v]].id);break}return a.append("env",o.env),a.append("sesskey",M.cfg.sesskey),a.append("client_id",o.client_id),a.append("savepath",u),a.append("ctx_id",o.context.id),f=(new Date).getTime(),l="moodleimage_"+Math.round(Math.random()*1e5)+"-"+f,r.focus(),r.restoreSelection(),h=i({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",d),id:l}),r.insertContentAtFocusPoint(h),n.markUpdated(),c.onreadystatechange=function(){var t=n.editor.one("#"+l),r,s,o,u;if(c.readyState===4)if(c.status===200){r=JSON.parse(c.responseText);if(r){if(r.error)return t&&t.remove(!0),new M.core.ajaxException(r);s=r,r.event&&r.event==="fileexists"&&(s=r.newfile),o=i({url:s.url,presentation:!0}),u=e.Node.create(o),t?t.replace(u):n.editor.appendChild(u),n.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),t&&t.remove(!0)},c.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),c.send(a),!1}},_handleClick:function(e){var t=e.target;this._initEditableImg(t),e.halt(!0)},_initEditableImg:function(t){var n=this,r=this._editableImg&&this._editableImg.node.getDOMNode()===t.getDOMNode();if(r)return;var i=this._editableImg&&this._editableImg.node.getDOMNode()!==t.getDOMNode();i&&this._destroyEditableImg(),this._editableImg=new e.M.atto_image.EditableImg({node:t,host:this.get("host"),after:{init:function(){this.on("atto_image_EditableImg:init",n._editableImgInitHandler,n),this.fire("atto_image_EditableImg:init")}}})},_destroyEditableImg:function(){this._editableImg&&(this._editableImg.destroy(),this._editableImg=null,this._destroyResizable(this._resizable),this._destroyRotatable(this._rotatable))},_editableImgInitHandler:function(e){var t=e.target;this._initRotatable(t),this._initResizable(t),t.recalculateImgWrapper()},_handleDeselect:function(){this._editableImg&&(this._destroyEditableImg(),this._editableImg=null)},_resizableInitHandler:function(e){var t=e.currentTarget;t!==this._resizable&&(this._resizable=t,this._resizable.enable())},_resizableDeleteHandler:function(e){var t=e.target;this._destroyResizable(t)},_resizableResizeStartHandler:function(e){var t=e.target;t.node.removeClass(l.RESPONSIVE)},_initResizable:function(t){if(!e.M.atto_image.resizable.isSupported())return;var n=this,r={editableImg:t,after:{init:function(){this.on("atto_image_resizable:init",n._resizableInitHandler,n),this.fire("atto_image_resizable:init")}}};this._resizable=new e.M.atto_image.resizable(r),this._resizable.on("atto_image_resizable:resize:start",this._resizableResizeStartHandler,this),this._resizable.on("atto_image_resizable:dblclick",this._displayDialogueWhileResizing,this),this._resizable.on("atto_image_resizable:delete",this._resizableDeleteHandler,this)},_destroyResizable:function(e){e==this._resizable&&(this._resizable=null),e&&e.destroy()},_initRotatable:function(t){var n={editableImg:t,after:{init:function(){this.fire("atto_image_rotatable:init")}}};this._rotatable=new e.M.atto_image.rotatable(n)},_destroyRotatable:function(e){e==this._rotatable&&(this._rotatable=null),e&&e.destroy()},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("imageproperties",d),width:"480px",focusAfterHide:!0,focusOnShowSelector:c.INPUTURL});e.set("bodyContent",this._getDialogueContent()).show()},_displayDialogueWhileResizing:function(e){var t=e.resizable;if(t){var n=t.node;this._destroyResizable(t);var r=this.get("host"
).getSelectionFromNode(n);this.get("host").setSelection(r),this._currentSelection=this.get("host").getSelection()}this._displayDialogue(),e.stopImmediatePropagation()},_loadPreviewImage:function(e){var t=new Image,n=this;t.onerror=function(){var e=n._form.one("."+l.IMAGEPREVIEW);e.setStyles({display:"none"}),n.getDialogue().centerDialogue()},t.onload=function(){var e,t,r,i,s;n._rawImageDimensions={width:this.width,height:this.height},e=n._form.one("."+l.INPUTWIDTH),t=e.get("value"),t===""&&(e.set("value",this.width),t=""+this.width),e=n._form.one("."+l.INPUTHEIGHT),r=e.get("value"),r===""&&(e.set("value",this.height),r=""+this.height),e=n._form.one("."+l.IMAGEPREVIEW),e.setAttribute("src",this.src),e.setStyles({display:"inline"}),e=n._form.one("."+l.INPUTCONSTRAIN),t.match(p.ISPERCENT)&&r.match(p.ISPERCENT)?e.set("checked",t===r):(this.width===0&&(this.width=1),this.height===0&&(this.height=1),i=Math.round(1e3*parseInt(t,10)/this.width),s=Math.round(1e3*parseInt(r,10)/this.height),e.set("checked",i===s)),n._autoAdjustSize(n),n.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var t=e.Handlebars.compile(v),n=this.get("host").canShowFilepicker("image"),r=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:l,component:d,showFilepicker:n,alignments:h}));return this._form=r,this._applyImageProperties(this._form),this._form.one("."+l.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+l.IMAGEPRESENTATION).on("change",this._updateWarning,this),this._form.one("."+l.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+l.INPUTWIDTH).on("blur",this._autoAdjustSize,this),this._form.one("."+l.INPUTHEIGHT).on("blur",this._autoAdjustSize,this,!0),this._form.one("."+l.INPUTCONSTRAIN).on("change",function(e){e.target.get("checked")&&this._autoAdjustSize(e)},this),this._form.one("."+l.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+l.INPUTSUBMIT).on("click",this._setImage,this),n&&this._form.one("."+l.IMAGEBROWSER).on("click",function(){this.get("host").showFilepicker("image",this._filepickerCallback,this)},this),r},_autoAdjustSize:function(e,t){t=t||!1;var n=this._form.one("."+l.INPUTWIDTH),r="width",i=this._form.one("."+l.INPUTHEIGHT),s="height",o=this._form.one("."+l.INPUTCONSTRAIN),u=n.get("value"),a=i.get("value"),f=this._form.one("."+l.IMAGEPREVIEW),c,h;if(!this._rawImageDimensions)return;u===""&&(u=this._rawImageDimensions[r],n.set("value",u),u=n.get("value")),f.setStyles({width:null,height:null});if(!o.get("checked"))u.match(p.ISPERCENT)?(c=parseInt(u,10),h=this._rawImageDimensions.width/100*c,f.setStyle("width",h+"px")):f.setStyle("width",u+"px"),a.match(p.ISPERCENT)?(c=parseInt(a,10),h=this._rawImageDimensions.height/100*c,f.setStyle("height",h+"px")):f.setStyle("height",a+"px");else{if(t){var d;d=n,n=i,i=d,d=r,r=s,s=d,d=u,u=a,a=d}u.match(p.ISPERCENT)?(a=u,c=parseInt(u,10),h=this._rawImageDimensions.width/100*c,f.setStyle("width",h),h=this._rawImageDimensions.height/100*c,f.setStyle("height",h)):(a=Math.round(u/this._rawImageDimensions[r]*this._rawImageDimensions[s]),t?f.setStyles({width:a,height:u}):f.setStyles({width:u,height:a})),i.set("value",a)}},_filepickerCallback:function(e){if(e.url!==""){var t=this._form.one("."+l.INPUTURL);t.set("value",e.url),this._form.one("."+l.INPUTWIDTH).set("value",""),this._form.one("."+l.INPUTHEIGHT).set("value",""),this._loadPreviewImage(e.url)}},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),n=e.one("."+l.IMAGEPREVIEW),r,i;if(t===!1){n.setStyle("display","none");for(r in h)h[r].isDefault===!0&&(i=h[r].value+":"+h[r].name+";",e.one("."+l.INPUTALIGNMENT).set("value",i));e.one("."+l.INPUTALIGNMENT).getDOMNode().options.remove(h.length-1);return}t.align?(e.one("."+l.INPUTALIGNMENT).set("value",t.align),e.one("."+l.INPUTALIGNMENT).getDOMNode().options.remove(h.length-1)):e.one("."+l.INPUTALIGNMENT).set("value","style:customstyle;"),t.customstyle&&e.one("."+l.INPUTCUSTOMSTYLE).set("value",t.customstyle),t.width&&e.one("."+l.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+l.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+l.INPUTALT).set("value",t.alt),t.src&&(e.one("."+l.INPUTURL).set("value",t.src),this._loadPreviewImage(t.src)),t.presentation&&e.one("."+l.IMAGEPRESENTATION).set("checked","checked"),this._autoAdjustSize()},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null,align:"",presentation:!1},t=this.get("host").getSelectedNodes(),n,r,i,s,o,u,a;t&&(t=t.filter("img"));if(t&&t.size()){u=t.item(0),this._selectedImage=u,s=u.getAttribute("style"),e.customstyle=s,s=s.replace(/ /g,""),r=u.getAttribute("width"),r.match(p.ISPERCENT)||(r=parseInt(r,10)),i=u.getAttribute("height"),i.match(p.ISPERCENT)||(i=parseInt(i,10)),r!==0&&(e.width=r),i!==0&&(e.height=i);for(n in h){o=h[n].value+":"+h[n].name+";";if(s.indexOf(o)!==-1){a="margin:"+h[n].margin+";",a=a.replace(/ /g,"");if(s.indexOf(a)!==-1){e.align=o;break}}}return e.src=u.getAttribute("src"),e.alt=u.getAttribute("alt")||"",e.presentation=u.get("role")==="presentation",e}return this._selectedImage=null,!1},_urlChanged:function(){var e=this._form.one("."+l.INPUTURL);e.get("value")!==""&&this._loadPreviewImage(e.get("value"))},_setImage:function(t){var n=this._form,r=n.one("."+l.INPUTURL).get("value"),i=n.one("."+l.INPUTALT).get("value"),s=n.one("."+l.INPUTWIDTH).get("value"),o=n.one("."+l.INPUTHEIGHT).get("value"),u=n.one("."+l.INPUTALIGNMENT).get("value"),a="",f=n.one("."+l.IMAGEPRESENTATION).get("checked"),c=n.one("."+l.INPUTCONSTRAIN).get("checked"),d,v="",g,y,b=[],w=this.get("host");t.preventDefault();if(this._updateWarning())return;w.focus();if(r!==""){this._selectedImage?w.setSelection(w.getSelectionFromNode(this._selectedImage)):w.setSelection(this._currentSelection);if(u==="style:customstyle;")u="",v=n.one("."+l.INPUTCUSTOMSTYLE).get("value");else for(g in h)y=h[g].value+":"+h[g].name+";",u===y&&(a=" margin: "+h[g].margin+";");c&&b.push(l.RESPONSIVE);if(!s.match(p.ISPERCENT
)&&isNaN(parseInt(s,10))){n.one("."+l.INPUTWIDTH).focus();return}if(!o.match(p.ISPERCENT)&&isNaN(parseInt(o,10))){n.one("."+l.INPUTHEIGHT).focus();return}var E=e.Handlebars.compile(m);d=E({url:r,alt:i,width:s,height:o,presentation:f,alignment:u,margin:a,customstyle:v,classlist:b.join(" ")}),this.get("host").insertContentAtFocusPoint(d),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()},_updateWarning:function(){var e=this._form,t=!0,n=e.one("."+l.INPUTALT).get("value"),r=e.one("."+l.IMAGEPRESENTATION).get("checked");return n===""&&!r?(e.one("."+l.IMAGEALTWARNING).setStyle("display","block"),e.one("."+l.INPUTALT).setAttribute("aria-invalid",!0),e.one("."+l.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),t=!0):(e.one("."+l.IMAGEALTWARNING).setStyle("display","none"),e.one("."+l.INPUTALT).setAttribute("aria-invalid",!1),e.one("."+l.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),t=!1),this.getDialogue().centerDialogue(),t}})},"@VERSION@",{requires:["moodle-editor_atto-rangy","moodle-editor_atto-plugin","resize","resize-plugin"]});
