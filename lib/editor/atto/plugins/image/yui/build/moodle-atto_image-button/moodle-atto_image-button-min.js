YUI.add("moodle-atto_image-button",function(e,t){e.namespace("M.atto_image"),e.M.atto_image.resizeHandles={T:"t",TR:"tr",R:"r",BR:"br",B:"b",BL:"bl",L:"l",TL:"tl"},e.M.atto_image.imgWrapperTemplate='<div class="atto-image-wrapper" contenteditable="false"></div>',e.M.atto_image.innerImgWrapperTemplate='<div class="atto-image-inner-wrapper" contenteditable="false"></div>',e.M.atto_image.innerImgWrapperCoordinateHelpers='<div class="atto-image-helper-inner-wrapper-coordinate atto_control" contenteditable="false">    <div class="yui3-resize-handle yui3-resize-handle-tl"></div></div>',e.M.atto_image.imageEditableClass="atto-image-helper-editable",e.M.atto_image.resizeOverlayNodeTemplate='<div class="atto-image-resize-overlay atto_control {{classes}}"></div>',e.M.atto_image.rotateHandleTemplate='<div class="atto-image-rotate-handle-container atto_control atto-image-editable-helper-wrapper"      contenteditable="false">    <div class="atto-image-rotate-handle-vertical-line"></div>    <div class="atto-image-rotate-handle"></div></div>',e.M.atto_image.cropOverlayNodeTemplate='<div class="atto-image-crop-overlay atto_control" contenteditable="false"></div>',e.M.atto_image.utility={parseInt10:function(e){return parseInt(e,10)},getNaturalImageSize:function(e){var t=new Image;return t.src=e,{width:t.width,height:t.height}},getNodeSize:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("width"))-e.M.atto_image.utility.getHorizontalNonContentWidth(t),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("height"))-e.M.atto_image.utility.getVerticalNonContentWidth(t);return{width:n,height:r}},getNaturalImageAspectRatio:function(e){var t=1e3;return e.width*t/(e.height*t)},getHorizontalBorderWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-left-width")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-right-width"));return n+r},getVerticalBorderWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-top-width")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("border-bottom-width"));return n+r},getHorizontalPaddingWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-left")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-right"));return n+r},getVerticalPaddingWidth:function(t){var n=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-bottom")),r=e.M.atto_image.utility.parseInt10(t.getComputedStyle("padding-top"));return n+r},getHorizontalNonContentWidth:function(e){return this.getHorizontalBorderWidth(e)+this.getHorizontalPaddingWidth(e)},getVerticalNonContentWidth:function(e){return this.getVerticalBorderWidth(e)+this.getVerticalPaddingWidth(e)},rangyCompare:function(e,t){return e.startContainer==t.startContainer&&e.endContainer==t.endContainer&&e.startOffset==t.startOffset&&e.endOffset==t.endOffset},disableContentEditable:function(e){e.all(".atto-image-wrapper").each(function(e){e.getDOMNode().setAttribute("contenteditable",!1)}),e.all("img").each(function(e){e.getDOMNode().setAttribute("unselectable","on")})},getNodeCenterClientCoord:function(e){var t=e.getDOMNode().getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}},get2DAngle:function(t,n){var r=n.x-t.x,i=n.y-t.y;return-(e.M.atto_image.utility.radToDeg(Math.atan2(r,i))-180)},degToRad:function(e){return e*(Math.PI/180)},radToDeg:function(e){return e*(180/Math.PI)},rotateNode:function(e,t){var n=e.getDOMNode();n.style.webkitTransform="rotate("+t+"deg)",n.style.mozTransform="rotate("+t+"deg)",n.style.msTransform="rotate("+t+"deg)",n.style.oTransform="rotate("+t+"deg)",n.style.transform="rotate("+t+"deg)"},getRotateNode:function(e){function t(e){var t=window.getComputedStyle(e,null),n=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"none";if(n=="none")return 0;var r=n.split("(")[1].split(")")[0].split(","),i=r[0],s=r[1],o=Math.atan2(s,i)*(180/Math.PI);return o<0&&(o+=360),o}return t(e.getDOMNode())},rotate:function(t,n){n=-n;var r=e.M.atto_image.utility.degToRad(n),i=Math.cos(r),s=Math.sin(r),o=i*t.x+s*t.y,u=i*t.y-s*t.x;return{x:o,y:u}},normalizeCoordinate:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},getInlineStyles:function(e){var t=e.getDOMNode().getAttribute("style"),n=t.split(";");n=n.filter(function(e){return e.indexOf(":")!==-1});var r={};return n.forEach(function(e){var t=e.trim().split(":");r[t[0]]=t[1]}),r},setInlineStyles:function(e,t){var n=[];for(var r in t)n.push(r+": "+t[r]);e.getDOMNode().setAttribute("style",n.join("; "))},cleanupInlineStyles:function(t,n){var r=e.M.atto_image.utility.getInlineStyles(t),i={};for(var s in r)n.indexOf(s)>=0&&(i[s]=r[s]);e.M.atto_image.utility.setInlineStyles(t,i)}},e.M.atto_image.DeleteMutationObserver=function(){e.M.atto_image.DeleteMutationObserver.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.DeleteMutationObserver,e.Base,{node:null,_mutationObserver:null,_childrenMutationObserver:null,_mutationObserverConfig:{childList:!0,subtree:!0},_deletionCallback:null,_start:!1,initializer:function(t){this.node=t.node,this._deletionCallback=t.deletionCallback,delete t.node,delete t.deletionCallback,this._mutationObserverConfig=e.merge(this._mutationObserverConfig,t)},destructor:function(){this.detachAll(),this.stop()},start:function(){this._start=!0,this._childrenMutationObserver=new MutationObserver(function(e){var t=!this.node;if(t)return;e.forEach(function(e){var t=e.removedNodes.length>0;t&&this._start&&this._deletionCallback&&this._deletionCallback(e.removedNodes)}.bind(this))}.bind(this)),this._childrenMutationObserver.observe(this.node.getDOMNode(),this._mutationObserverConfig),this._mutationObserver=new MutationObserver(function(e){var t=!this.node;if(t)return;e.forEach(function(e){var t=e.removedNodes.length>0;t&&this._start&&[].indexOf.call(e.removedNodes,this.node.getDOMNode
())>=0&&this._deletionCallback&&this._deletionCallback(e.removedNodes)}.bind(this))}.bind(this)),this._mutationObserver.observe(this.node.ancestor().getDOMNode(),this._mutationObserverConfig)},stop:function(){this._start=!1,this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=null),this._childrenMutationObserver&&(this._childrenMutationObserver.disconnect(),this._childrenMutationObserver=null)}},{NAME:"atto_image_DeleteMutationObserver",isSupported:function(){var t=e.Lang.isObject(window.MutationObserver);return t}}),e.M.atto_image.EditableImg=function(){e.M.atto_image.EditableImg.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.EditableImg,e.Base,{node:null,innerNodeWrapper:null,host:null,_enable:!1,_nodeDeletionMutationObserver:null,_orientation:e.M.atto_image.resizeHandles.T,nodeWrapper:null,initializer:function(t){this.node=t.node,this.nodeWrapper=this.node.ancestor(".atto-image-wrapper"),this.innerNodeWrapper=this.node.ancestor(".atto-image-inner-wrapper");if(!this.nodeWrapper||!this.innerNodeWrapper)this.node.wrap(e.M.atto_image.innerImgWrapperTemplate),this.innerNodeWrapper=this.node.ancestor(".atto-image-inner-wrapper"),this.innerNodeWrapper.wrap(e.M.atto_image.imgWrapperTemplate),this.nodeWrapper=this.node.ancestor(".atto-image-wrapper"),this.innerNodeWrapper.setStyles(this.getOriginalImgSize());this.innerImgWrapperCoordinateHelpers=e.Node.create(e.M.atto_image.innerImgWrapperCoordinateHelpers),this.innerNodeWrapper.appendChild(this.innerImgWrapperCoordinateHelpers),this.host=t.host,this.enable(),this._publishEvents()},destructor:function(){this.innerImgWrapperCoordinateHelpers.remove(!0),this.detachAll(),this.disable()},enable:function(){if(this._enable)return;this._setupImgWrapper(),this._setupImgNode(),this.startDeleteMutationObserver(),this.select(),this._enable=!0},disable:function(){if(!this._enable)return;this.node.detachAll(),this.nodeWrapper.detachAll(),this.stopDeleteMutationObserver(),this._destroyImgNode(),this._destroyImgWrapper(),this._enable=!1},startDeleteMutationObserver:function(){this._nodeDeletionMutationObserver||(this._nodeDeletionMutationObserver=new e.M.atto_image.DeleteMutationObserver({node:this.node,deletionCallback:this._onDelete.bind(this)}),this._nodeDeletionMutationObserver.start())},stopDeleteMutationObserver:function(){this._nodeDeletionMutationObserver&&(this._nodeDeletionMutationObserver.stop(),this._nodeDeletionMutationObserver=null)},getNode:function(){return this.node},getImgWrapperXY:function(){return this.innerImgWrapperCoordinateHelpers.one(".yui3-resize-handle-tl").getXY()},getImgWrapper:function(){return this.nodeWrapper},getOrientation:function(){return this._orientation},getOriginalImgSize:function(){return{width:this.node.getAttribute("width"),height:this.node.getAttribute("height")}},setOriginalImgSize:function(e){this.node.setAttrs({width:e.width,height:e.height})},getOriginalImgOffset:function(){return{left:parseFloat(this.node.getStyle("left")),top:parseFloat(this.node.getStyle("top"))}},setOriginalImgOffset:function(e){this.node.setStyles({left:e.left+"px",top:e.top+"px"})},getImgSize:function(){return{width:parseFloat(this.innerNodeWrapper.getStyle("width")),height:parseFloat(this.innerNodeWrapper.getStyle("height"))}},setSize:function(e){var t=this.getImgSize(),n={width:e.width/t.width,height:e.height/t.height};this.innerNodeWrapper.setStyles({width:e.width,height:e.height}),this.nodeWrapper.setStyles({width:e.width,height:e.height});var r=this.getOriginalImgSize(),i={width:n.width*r.width,height:n.height*r.height};this.setOriginalImgSize(i);var s=this.getOriginalImgOffset(),o={left:n.width*s.left,top:n.height*s.top};this.setOriginalImgOffset(o),this.fire("transform")},getRotation:function(){return e.M.atto_image.utility.getRotateNode(this.innerNodeWrapper)},setRotation:function(t){e.M.atto_image.utility.rotateNode(this.innerNodeWrapper,t),this.nodeWrapper.get("children").each(function(n){n.hasClass("atto_control")&&e.M.atto_image.utility.rotateNode(n,t)}),this._updateOrientation(),this.fire("transform")},recalculateImgWrapper:function(){var e=this.innerNodeWrapper.getDOMNode().getBoundingClientRect();this._updateOrientation(),this.nodeWrapper.setStyles({width:e.width,height:e.height}),this.nodeWrapper.get("children").each(function(t){t.setStyles({left:(e.width-this.getImgSize().width)/2,top:(e.height-this.getImgSize().height)/2}),t.setStyles(this.getImgSize())},this),this.fire("recalculated"),this.select()},select:function(){window.rangy.getSelection().removeAllRanges();var e=this.getSelection();this.host.setSelection(e)},getSelection:function(){var t=null,n=e.UA.gecko>0;if(n){this.nodeWrapper.insert('<span class="atto_control">',"before"),this.nodeWrapper.insert('<span class="atto_control">',"after");var r=window.rangy.createRange();r.setStartBefore(this.nodeWrapper.getDOMNode()),r.setEndAfter(this.nodeWrapper.getDOMNode()),r.setStart(r.startContainer,r.startOffset-1),r.setEnd(r.endContainer,r.endOffset+1),t=[r]}else t=this.host.getSelectionFromNode(this.nodeWrapper);return t},addControl:function(t){t.addClass("atto_control"),e.M.atto_image.utility.rotateNode(t,this.getRotation()),this.nodeWrapper.appendChild(t)},_publishEvents:function(){this.publish("click",{prefix:e.M.atto_image.EditableImg.NAME,emitFacade:!0,broadcast:2},this),this.publish("dblclick",{prefix:e.M.atto_image.EditableImg.NAME,emitFacade:!0,broadcast:2},this),this.publish("init",{prefix:e.M.atto_image.EditableImg.NAME,emitFacade:!0,broadcast:2,context:this},this),this.publish("delete",{prefix:e.M.atto_image.EditableImg.NAME,emitFacade:!0,broadcast:2,context:this},this),this.publish("transform",{prefix:e.M.atto_image.EditableImg.NAME,emitFacade:!0,broadcast:2,context:this},this),this.publish("recalculated",{prefix:e.M.atto_image.EditableImg.NAME,emitFacade:!0,broadcast:2,context:this},this)},_enableImageEditable:function(t){t.addClass(e.M.atto_image.imageEditableClass)},_disableImageEditable:function(t){t.removeClass
(e.M.atto_image.imageEditableClass)},_setupImgNode:function(){},_destroyImgNode:function(){this.node.detachAll()},_setupInnerNodeWrapper:function(){},_destroyInnerNodeWrapper:function(){this.innerNodeWrapper.detachAll()},_setupImgWrapper:function(){if(!this.nodeWrapper)return;this.nodeWrapper.setAttribute("contenteditable",!0),this.nodeWrapper.setStyles(this.getImgSize()),this.nodeWrapper.on("click",this._onClick,this),this.nodeWrapper.on("dblclick",this._onDblClick,this),this.nodeWrapper.get("children").each(function(e){e.on("click",this._onClick,this),e.on("dblclick",this._onDblClick,this)},this),this.nodeWrapper.before("dragstart",function(e){e.halt(!0)},this),this._enableImageEditable(this.nodeWrapper)},_destroyImgWrapper:function(){if(!this.nodeWrapper)return;this._disableImageEditable(this.nodeWrapper),this._removeOrientationClasses(this.nodeWrapper),this.nodeWrapper.get("children").each(function(e){e.detach("dblclick",this._onDblClick,this),e.detach("click",this._onClick,this)},this),this.nodeWrapper.detachAll(),this.nodeWrapper.setAttribute("contenteditable",!1)},_onClick:function(e){e.stopPropagation(),this.fire("click",e),this.select()},_onDblClick:function(e){e.stopPropagation(),this.fire("dblclick",e),this.select()},_onDelete:function(){this.disable(),this.nodeWrapper.remove(!0),this.fire("delete")},_updateOrientation:function(){var t=this.getRotation(),n=t>=330&&t<=360||t>=0&&t<30,r=t>=30&&t<60,i=t>=60&&t<120,s=t>=120&&t<150,o=t>=150&&t<210,u=t>=210&&t<240,a=t>=240&&t<300,f=t>=300&&t<330;n?this._orientation=e.M.atto_image.resizeHandles.T:r?this._orientation=e.M.atto_image.resizeHandles.TL:a?this._orientation=e.M.atto_image.resizeHandles.R:s?this._orientation=e.M.atto_image.resizeHandles.BL:o?this._orientation=e.M.atto_image.resizeHandles.B:u?this._orientation=e.M.atto_image.resizeHandles.BR:i?this._orientation=e.M.atto_image.resizeHandles.L:f&&(this._orientation=e.M.atto_image.resizeHandles.TR),this._removeOrientationClasses(this.nodeWrapper),this.nodeWrapper.addClass("atto-image-helper-orientation-"+this._orientation)},_removeOrientationClasses:function(e){e.removeClass("atto-image-helper-orientation-t"),e.removeClass("atto-image-helper-orientation-tl"),e.removeClass("atto-image-helper-orientation-r"),e.removeClass("atto-image-helper-orientation-bl"),e.removeClass("atto-image-helper-orientation-b"),e.removeClass("atto-image-helper-orientation-br"),e.removeClass("atto-image-helper-orientation-l"),e.removeClass("atto-image-helper-orientation-tr")}},{NAME:"atto_image_EditableImg",isSupported:function(){var t=e.M.atto_image.DeleteMutationObserver.isSupported();return t},clean:function(t){e.M.atto_image.utility.cleanupInlineStyles(t,e.M.atto_image.EditableImg.validInlineStyles.nodeWrapper);var n=t.one(".atto-image-inner-wrapper");e.M.atto_image.utility.cleanupInlineStyles(n,e.M.atto_image.EditableImg.validInlineStyles.innerNodeWrapper);var r=t.one(".atto-image-inner-wrapper > img");return e.M.atto_image.utility.cleanupInlineStyles(r,e.M.atto_image.EditableImg.validInlineStyles.node),t},validInlineStyles:{nodeWrapper:["width","height","float","margin"],innerNodeWrapper:["width","height","left","top","transform"],node:["width","height","left","top"]}}),e.M.atto_image.resizable=function(){e.M.atto_image.resizable.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.resizable,e.Base,{node:null,_editableImg:null,_resizableOverlay:null,_resizableOverlayNode:null,_enable:!1,initializer:function(e){this._editableImg=e.editableImg,this.node=this._editableImg.node,this.enable(),this._publishEvents()},destructor:function(){this.disable()},enable:function(){if(this._enable)return;this._editableImg.on("click",this._onClick.bind(this)),this._editableImg.on("dblclick",this._onDblClick.bind(this)),this._resizableOverlayNode=this._createResizeOverlayNode(),this._editableImg.addControl(this._resizableOverlayNode,!1),e.M.atto_image.utility.rotateNode(this._resizableOverlayNode,0),this._resizableOverlay=this._createResizeOverlay(this._resizableOverlayNode,this._editableImg.innerNodeWrapper),e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),this._editableImg.getRotation()),this._resizableOverlay.align(),this._editableImg.on(["recalculated","transform"],this._onEditableImgRecalculated,this),this._enable=!0},disable:function(){if(!this._enable)return;this._editableImg.detach(["recalculated","transform"],this._onEditableImgRecalculated,this),this.detachAll(),this._resizableOverlay&&(this._resizableOverlay.destroy(!0),this._resizableOverlay=null),this._resizableOverlayNode&&(this._resizableOverlayNode.remove(!0),this._resizableOverlayNode=null),this._enable=!1},getNode:function(){return this.node},getImgWrapper:function(){return this._editableImg.getImgWrapper()},_publishEvents:function(){this.publish("click",{prefix:e.M.atto_image.resizable.NAME,emitFacade:!0,broadcast:2},this),this.publish("dblclick",{prefix:e.M.atto_image.resizable.NAME,emitFacade:!0,broadcast:2},this),this.publish("resize:start",{prefix:e.M.atto_image.resizable.NAME,emitFacade:!0,broadcast:2},this),this.publish("resize:resize",{prefix:e.M.atto_image.resizable.NAME,emitFacade:!0,broadcast:2},this),this.publish("resize:end",{prefix:e.M.atto_image.resizable.NAME,emitFacade:!0,broadcast:2},this),this.publish("init",{prefix:e.M.atto_image.resizable.NAME,emitFacade:!0,broadcast:2,context:this},this)},_createResizeOverlayNode:function(){var t=e.Handlebars.compile(e.M.atto_image.resizeOverlayNodeTemplate);return e.Node.create(t({classes:""}))},_createResizeOverlay:function(t,n){var r=new e.Overlay({srcNode:t,visible:!0,render:!0,align:{node:n,points:["tl","tl"]}});return this._setResizeOverlaySize(r),r.plug(e.Plugin.Resize,{handles:["t","r","b","l","tr","tl","br","bl"]}),r.resize.plug(e.Plugin.ResizeConstrained,{},this),r.resize.on("resize:start",this._onResizeStart,this),r.resize.on("resize:resize",this._onResize,this),r.resize.on("drag:end",this._onResizeEnd,this),r.get("boundingBox").addClass("atto_control"
),r.get("boundingBox").addClass("atto-image-editable-helper-wrapper"),r.get("boundingBox").addClass("atto-image-resize-overlay-wrapper"),r.get("boundingBox").setAttribute("contenteditable",!1),r},_onResizeStart:function(e){this.fire("resize:start",e)},_onResize:function(t){this._resizableOverlay.align();switch(this._resizableOverlay.resize.handle){case e.M.atto_image.resizeHandles.TL:case e.M.atto_image.resizeHandles.TR:case e.M.atto_image.resizeHandles.BL:case e.M.atto_image.resizeHandles.BR:this._resizableOverlay.resize.con.set("preserveRatio",!0);break;default:this._resizableOverlay.resize.con.set("preserveRatio",!1)}this.fire("resize:resize",t)},_onResizeEnd:function(e){this._resizableOverlay.align(),this._editableImg.setSize(this._getResizeOverlaySize()),this._editableImg.recalculateImgWrapper(),this.fire("resize:end",e)},_onClick:function(e){e.stopPropagation(),this.fire("click",e)},_onDblClick:function(e){e.stopPropagation(),this.fire("dblclick",e)},_onEditableImgRecalculated:function(){if(!this._enable)return;var t=this._editableImg.getRotation(),n=this._editableImg.getOrientation();n==e.M.atto_image.resizeHandles.R?e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t+90):n==e.M.atto_image.resizeHandles.B||n==e.M.atto_image.resizeHandles.BR||n==e.M.atto_image.resizeHandles.BL?e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t+180):n==e.M.atto_image.resizeHandles.L?e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t+270):e.M.atto_image.utility.rotateNode(this._resizableOverlay.get("boundingBox"),t),this._setResizeOverlaySize(),this._resizableOverlay.align()},_getResizeOverlaySize:function(){var t=this._resizableOverlay.resize.info.offsetWidth,n=this._resizableOverlay.resize.info.offsetHeight,r={width:t,height:n},i=this._editableImg.getOrientation();if(i==e.M.atto_image.resizeHandles.L||i==e.M.atto_image.resizeHandles.R)r={width:n,height:t};return r},_setResizeOverlaySize:function(t){t=t||this._resizableOverlay;var n=this._editableImg.getImgSize(),r=this._editableImg.getOrientation();if(r==e.M.atto_image.resizeHandles.L||r==e.M.atto_image.resizeHandles.R)n={width:n.height,height:n.width};t.get("boundingBox").setStyles(n)}},{NAME:"atto_image_resizable"}),e.M.atto_image.rotatable=function(){e.M.atto_image.rotatable.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.rotatable,e.Base,{node:null,_editableImg:null,_enable:!1,_rotateControlNode:null,_rotateControlHandleNode:null,initializer:function(e){this._editableImg=e.editableImg,this.node=this._editableImg.node,this.enable(),this._publishEvents()},destructor:function(){this.disable()},enable:function(){if(this._enable)return;this._rotateControlNode=e.Node.create(e.M.atto_image.rotateHandleTemplate),this._rotateControlHandleNode=this._rotateControlNode.one(".atto-image-rotate-handle"),this._rotateControlNode.addClass("atto-image-editable-helper-wrapper");var t=!1;this._rotateControlHandleNode.on(["mousedown"],function(e){t=!0,this._onRotateStart(e)},this),this._rotateControlHandleNode.on(["mousemove","mousemoveoutside"],function(e){t&&this._onRotate(e)},this),this._rotateControlHandleNode.on(["mouseup","mouseupoutside"],function(e){t&&this._onRotateEnd(e),t=!1},this),this._editableImg.addControl(this._rotateControlNode),this._editableImg.on("click",this._onClick,this),this._editableImg.on("dblclick",this._onDblClick,this),this._editableImg.on("recalculated",this._onEditableImgRecalculated,this),this._enable=!0},disable:function(){if(!this._enable)return;this._editableImg.detach("recalculated",this._onEditableImgRecalculated,this),this._editableImg.detach("dblclick",this._onDblClick,this),this._editableImg.detach("click",this._onClick,this),this.detachAll(),this._rotateControlHandleNode&&(this._rotateControlHandleNode.remove(!0),this._rotateControlHandleNode=null),this._rotateControlNode&&(this._rotateControlNode.remove(!0),this._rotateControlNode=null),this._enable=!1},_publishEvents:function(){this.publish("click",{prefix:e.M.atto_image.rotatable.NAME,emitFacade:!0,broadcast:2},this),this.publish("dblclick",{prefix:e.M.atto_image.rotatable.NAME,emitFacade:!0,broadcast:2},this),this.publish("rotate:start",{prefix:e.M.atto_image.rotatable.NAME,emitFacade:!0,broadcast:2},this),this.publish("rotate:rotate",{prefix:e.M.atto_image.rotatable.NAME,emitFacade:!0,broadcast:2},this),this.publish(e.M.atto_image.rotatable.NAME+":rotate:end",{prefix:e.M.atto_image.rotatable.NAME,emitFacade:!0,broadcast:2},this),this.publish("init",{prefix:e.M.atto_image.rotatable.NAME,emitFacade:!0,broadcast:2,context:this},this)},_onClick:function(e){e.stopPropagation(),this.fire("click",e)},_onDblClick:function(e){e.stopPropagation(),this.fire("dblclick",e)},_onRotateStart:function(){this.fire("rotate:start")},_onRotate:function(t){var n={x:t.clientX,y:t.clientY},r=e.M.atto_image.utility.getNodeCenterClientCoord(this._editableImg.innerNodeWrapper),i=e.M.atto_image.utility.get2DAngle(r,n);this._editableImg.setRotation(i),this.fire("rotate:rotate")},_onRotateEnd:function(){this._editableImg.recalculateImgWrapper(),this.fire("rotate:end")},_onEditableImgRecalculated:function(){if(!this._enable)return}},{NAME:"atto_image_rotatable"}),e.M.atto_image.croppable=function(){e.M.atto_image.croppable.superclass.constructor.apply(this,arguments)},e.extend(e.M.atto_image.croppable,e.Base,{node:null,_editableImg:null,_cropOverlay:null,_cropOverlayNode:null,_enable:!1,initializer:function(e){this._editableImg=e.editableImg,this.node=this._editableImg.node,this._publishEvents()},destructor:function(){this.disable()},enable:function(){if(this._enable)return;this._cropOverlayNode=this._createCropOverlayNode(),this._editableImg.addControl(this._cropOverlayNode,!1),e.M.atto_image.utility.rotateNode(this._cropOverlayNode,0),this._cropOverlay=this._createCropOverlay(this._cropOverlayNode,this._editableImg.node),e.M.atto_image.utility.rotateNode(this._cropOverlay.get("boundingBox"),this._editableImg
.getRotation()),this._cropOverlay.align(),this._editableImg.getImgWrapper().one(".yui3-resize-handles-wrapper").addClass("atto_control"),this._editableImg.getImgWrapper().addClass("atto-image-helper-show-cropped"),this._editableImg.on(["recalculated","transform"],this._onEditableImgRecalculated,this),this._enable=!0},disable:function(){if(!this._enable)return;this.detachAll(),this._editableImg.getImgWrapper().removeClass("atto-image-helper-show-cropped"),this._cropOverlay&&(this._cropOverlay.destroy(!0),this._cropOverlay=null),this._cropOverlayNode&&(this._cropOverlayNode.remove(!0),this._cropOverlayNode=null),this._enable=!1},_publishEvents:function(){this.publish("click",{prefix:e.M.atto_image.croppable.NAME,emitFacade:!0,broadcast:2},this),this.publish("dblclick",{prefix:e.M.atto_image.croppable.NAME,emitFacade:!0,broadcast:2},this),this.publish("crop:start",{prefix:e.M.atto_image.croppable.NAME,emitFacade:!0,broadcast:2},this),this.publish("crop:crop",{prefix:e.M.atto_image.croppable.NAME,emitFacade:!0,broadcast:2},this),this.publish("crop:end",{prefix:e.M.atto_image.croppable.NAME,emitFacade:!0,broadcast:2},this),this.publish("init",{prefix:e.M.atto_image.croppable.NAME,emitFacade:!0,broadcast:2,context:this},this)},_createCropOverlayNode:function(){var t=e.Handlebars.compile(e.M.atto_image.cropOverlayNodeTemplate);return e.Node.create(t())},_createCropOverlay:function(t,n){var r=new e.Overlay({srcNode:t,visible:!0,render:!0,align:{node:n,points:["tl","tl"]}});return this._setCropOverlaySize(r),r.plug(e.Plugin.Resize,{handles:["t","r","b","l","tr","tl","br","bl"]}),r.resize.plug(e.Plugin.ResizeConstrained,{},this),r.resize.on("resize:start",this._onCropStart,this),r.resize.on("resize:resize",this._onCrop,this),r.resize.on("drag:end",this._onCropEnd,this),r.plug(e.Plugin.Drag,{},this),r.dd.on("drag:start",this._onDragStart,this),r.dd.on("drag:drag",this._onDrag,this),r.dd.on("drag:end",this._onDragEnd,this),r.get("boundingBox").addClass("atto-image-editable-helper-wrapper"),r.get("boundingBox").addClass("atto-image-crop-overlay-wrapper"),r.get("boundingBox").addClass("atto_control"),r.get("boundingBox").setAttribute("contenteditable",!1),r},_onCropStart:function(e){this.fire("crop:start",e)},_onCrop:function(t){this._cropOverlay.align();switch(this._cropOverlay.resize.handle){case e.M.atto_image.resizeHandles.TL:case e.M.atto_image.resizeHandles.TR:case e.M.atto_image.resizeHandles.BL:case e.M.atto_image.resizeHandles.BR:this._cropOverlay.resize.con.set("preserveRatio",!0);break;default:this._cropOverlay.resize.con.set("preserveRatio",!1)}this.fire("crop:crop",t)},_onCropEnd:function(e){this._cropOverlay.align(),this._editableImg.setOriginalImgSize(this._getCropOverlaySize()),this._editableImg.recalculateImgWrapper(),this.fire("crop:end",e)},_onDragStart:function(e){this.fire("drag:start",e)},_onDrag:function(e){this._editableImg.setOriginalImgOffset(this._getCropOverlayOffset()),this.fire("drag:drag",e)},_onDragEnd:function(e){this._editableImg.setOriginalImgOffset(this._getCropOverlayOffset()),this._cropOverlay.align(),this.fire("drag:end",e)},_onEditableImgRecalculated:function(){if(!this._enable)return;var t=this._editableImg.getRotation(),n=this._editableImg.getOrientation();n==e.M.atto_image.resizeHandles.R?e.M.atto_image.utility.rotateNode(this._cropOverlay.get("boundingBox"),t+90):n==e.M.atto_image.resizeHandles.B||n==e.M.atto_image.resizeHandles.BR||n==e.M.atto_image.resizeHandles.BL?e.M.atto_image.utility.rotateNode(this._cropOverlay.get("boundingBox"),t+180):n==e.M.atto_image.resizeHandles.L?e.M.atto_image.utility.rotateNode(this._cropOverlay.get("boundingBox"),t+270):e.M.atto_image.utility.rotateNode(this._cropOverlay.get("boundingBox"),t),this._setCropOverlaySize(),this._cropOverlay.align()},_getCropOverlayXY:function(){var t=this._cropOverlay.resize.get("handlesWrapper");switch(this._editableImg.getOrientation()){case e.M.atto_image.resizeHandles.R:return t.one(".yui3-resize-handle-bl").getXY();case e.M.atto_image.resizeHandles.BR:case e.M.atto_image.resizeHandles.B:case e.M.atto_image.resizeHandles.BL:return t.one(".yui3-resize-handle-br").getXY();case e.M.atto_image.resizeHandles.L:return t.one(".yui3-resize-handle-tr").getXY();case e.M.atto_image.resizeHandles.T:case e.M.atto_image.resizeHandles.TR:case e.M.atto_image.resizeHandles.TL:return t.one(".yui3-resize-handle-tl").getXY();default:return t.one(".yui3-resize-handle-tl").getXY()}},_getCropOverlayOffset:function(){var t=e.M.atto_image.utility.normalizeCoordinate({x:this._getCropOverlayXY()[0],y:this._getCropOverlayXY()[1]},{x:this._editableImg.getImgWrapperXY()[0],y:this._editableImg.getImgWrapperXY()[1]}),n=e.M.atto_image.utility.rotate(t,-this._editableImg.getRotation());return{left:n.x,top:n.y}},_getCropOverlaySize:function(){var t=this._cropOverlay.resize.info.offsetWidth,n=this._cropOverlay.resize.info.offsetHeight,r={width:t,height:n},i=this._editableImg.getOrientation();if(i==e.M.atto_image.resizeHandles.L||i==e.M.atto_image.resizeHandles.R)r={width:n,height:t};return r},_setCropOverlaySize:function(t){t=t||this._cropOverlay;var n=this._editableImg.getOriginalImgSize(),r=this._editableImg.getOrientation();if(r==e.M.atto_image.resizeHandles.L||r==e.M.atto_image.resizeHandles.R)n={width:this._editableImg.getOriginalImgSize().height,height:this._editableImg.getOriginalImgSize().width};t.get("boundingBox").setStyles(n)},_removeOrientationClasses:function(e){e.removeClass("atto-image-helper-orientation-t"),e.removeClass("atto-image-helper-orientation-tl"),e.removeClass("atto-image-helper-orientation-r"),e.removeClass("atto-image-helper-orientation-bl"),e.removeClass("atto-image-helper-orientation-b"),e.removeClass("atto-image-helper-orientation-br"),e.removeClass("atto-image-helper-orientation-l"),e.removeClass("atto-image-helper-orientation-tr")}},{NAME:"atto_image_croppable"});var n={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry"
,INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box"},r={INPUTURL:"."+n.INPUTURL},i=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],s={ISPERCENT:/\d+%/},o="atto_image",u='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<div style="display:none" role="alert" class="warning {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><br/><input type="checkbox" class="{{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="sameline" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label><br/><label class="sameline" for="{{elementid}}_{{CSS.INPUTSIZE}}">{{get_string "size" component}}</label><div id="{{elementid}}_{{CSS.INPUTSIZE}}" class="{{CSS.INPUTSIZE}}"><label class="accesshide" for="{{elementid}}_{{CSS.INPUTWIDTH}}">{{get_string "width" component}}</label><input type="text" class="{{CSS.INPUTWIDTH}} input-mini" id="{{elementid}}_{{CSS.INPUTWIDTH}}" size="4"/> x <label class="accesshide" for="{{elementid}}_{{CSS.INPUTHEIGHT}}">{{get_string "height" component}}</label><input type="text" class="{{CSS.INPUTHEIGHT}} input-mini" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" size="4"/><input type="checkbox" class="{{CSS.INPUTCONSTRAIN}} sameline" id="{{elementid}}_{{CSS.INPUTCONSTRAIN}}"/><label for="{{elementid}}_{{CSS.INPUTCONSTRAIN}}">{{get_string "constrain" component}}</label></div><label class="sameline" for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="{{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}:{{name}};">{{get_string str ../component}}</option>{{/each}}</select><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>',a='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}unselectable="on" />';e.namespace("M.atto_image").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,_resizable:null,_rotatable:null,_croppable:null,_editableImg:null,initializer:function(){var t=this.get("host");this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"img",tagMatchRequiresAll:!1}),e.M.atto_image.utility.disableContentEditable(this.editor),this.editor.delegate("dblclick",this._displayDialogue,"img",this),this.editor.delegate("click",this._handleClick,"img",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.delegate("click",this._handleDeselect,":not(img)",this),this.editor.delegate("dragstart",function(e){e.halt(!0)},".atto-image-wrapper",this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this),t.on("atto:htmlcleaned",this._handleHtmlClean,this),t.on(["atto:pastehtmlstylescleaned","atto:pastehtmlclasscleaned"],this._handleClassStylesClean,this)},_handleHtmlClean:function(t){var n=t.args.html,r=!n;if(r){t.args.html="";return}n=n.replace(/(<[^>]*?class\s*?=\s*?")([^>"]*)(")/gi,function(e,t,n,r){var i=n.replace(/(?:^|[\s])[\s]*atto-image-helper[_a-zA-Z0-9\-]*/gi,"");return t+i+r});var i=document.createElement("div");i.innerHTML=n;var s=e.one(i);if(!s){t.args.html=n||"";return}s.all(".atto-image-wrapper .atto_control").remove(!0),s.all(".atto-image-wrapper > br").remove(!0),s.all(".atto-image-inner-wrapper > br").remove(!0),s.all(".atto-image-wrapper[contenteditable=true]").setAttribute("contenteditable",!1),s.all(".atto-image-wrapper").each(function(t){e.M.atto_image.EditableImg.clean(t)}),n=s.getHTML(),t.args.html=n},_handleClassStylesClean:function(t){var n=t.args,r=n.filter(function(t){return e.one(t).ancestor(".atto-image-wrapper",!0)});r.forEach(function(e){n.indexOf(e)>=0&&n.splice(n.indexOf(e),1)})},_handleDragDrop:function(t){var n=this,r=this.get("host"),i=e.Handlebars.compile(a);r.saveSelection(),t=t._event;var s=t.dataTransfer&&t.dataTransfer.files&&t.dataTransfer.files.length;if(s&&/^image\//.test(t.dataTransfer.files[0].type)){var u=r.get("filepickeroptions").image,f=u.savepath===undefined?"/":u.savepath,l=new FormData,c=0,h="",p=new XMLHttpRequest,d="",v=Object.keys(u.repositories);t.preventDefault(),t.stopPropagation(),l.append("repo_upload_file",t.dataTransfer.files[0]),l.append("itemid",
u.itemid);for(var m=0;m<v.length;m++)if(u.repositories[v[m]].type==="upload"){l.append("repo_id",u.repositories[v[m]].id);break}return l.append("env",u.env),l.append("sesskey",M.cfg.sesskey),l.append("client_id",u.client_id),l.append("savepath",f),l.append("ctx_id",u.context.id),c=(new Date).getTime(),h="moodleimage_"+Math.round(Math.random()*1e5)+"-"+c,r.focus(),r.restoreSelection(),d=i({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",o),id:h}),r.insertContentAtFocusPoint(d),n.markUpdated(),p.onreadystatechange=function(){var t=n.editor.one("#"+h),r,s,o,u;if(p.readyState===4)if(p.status===200){r=JSON.parse(p.responseText);if(r){if(r.error)return t&&t.remove(!0),new M.core.ajaxException(r);s=r,r.event&&r.event==="fileexists"&&(s=r.newfile),o=i({url:s.url,presentation:!0}),u=e.Node.create(o),t?t.replace(u):n.editor.appendChild(u),n.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),t&&t.remove(!0)},p.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),p.send(l),!1}},_handleClick:function(e){var t=e.target;this._initEditableImg(t),e.halt(!0)},_initEditableImg:function(t){if(!e.M.atto_image.EditableImg.isSupported())return;var n=this,r=this._editableImg&&this._editableImg.node.getDOMNode()===t.getDOMNode();if(r)return;var i=this._editableImg&&this._editableImg.node.getDOMNode()!==t.getDOMNode();i&&this._destroyEditableImg(),this._editableImg=new e.M.atto_image.EditableImg({node:t,host:this.get("host"),after:{init:function(){this.on("init",n._editableImgInitHandler,n),this.fire("init")}}}),this._editableImg.on("delete",this._destroyEditableImg,this)},_destroyEditableImg:function(){this._editableImg&&(this._editableImg.destroy(),this._editableImg=null,this._destroyCroppable(this._croppable),this._destroyResizable(this._resizable),this._destroyRotatable(this._rotatable))},_editableImgInitHandler:function(e){var t=e.target;t.node.removeClass(n.RESPONSIVE),this._initRotatable(t),this._initResizable(t),this._initCroppable(t),t.on("dblclick",function(){this._croppable&&(this._croppable._enable?this._croppable.disable():(this._croppable.enable(),t.recalculateImgWrapper()))},this),t.recalculateImgWrapper()},_handleDeselect:function(){this._editableImg&&(this._destroyEditableImg(),this._editableImg=null)},_resizableInitHandler:function(e){var t=e.currentTarget;t!==this._resizable&&(this._resizable=t,this._resizable.enable())},_resizableDeleteHandler:function(e){var t=e.target;this._destroyResizable(t)},_initResizable:function(t){var n=this,r={editableImg:t,after:{init:function(){this.on("init",n._resizableInitHandler,n),this.fire("init")}}};this._resizable=new e.M.atto_image.resizable(r)},_destroyResizable:function(e){e==this._resizable&&(this._resizable=null),e&&e.destroy()},_initRotatable:function(t){var n={editableImg:t,after:{init:function(){this.fire("init")}}};this._rotatable=new e.M.atto_image.rotatable(n)},_destroyRotatable:function(e){e==this._rotatable&&(this._rotatable=null),e&&e.destroy()},_initCroppable:function(t){var n={editableImg:t,after:{init:function(){this.fire("init")}}};this._croppable=new e.M.atto_image.croppable(n)},_destroyCroppable:function(e){e==this._croppable&&(this._croppable=null),e&&e.destroy()},_enableCroppable:function(){this._croppable&&this._croppable.enable()},_disableCroppable:function(){this._croppable&&this._croppable.disable()},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("imageproperties",o),width:"480px",focusAfterHide:!0,focusOnShowSelector:r.INPUTURL});e.set("bodyContent",this._getDialogueContent()).show()},_displayDialogueWhileEditing:function(e){var t=e.resizable;if(t){var n=t.node;this._destroyResizable(t);var r=this.get("host").getSelectionFromNode(n);this.get("host").setSelection(r),this._currentSelection=this.get("host").getSelection()}this._displayDialogue(),e.stopImmediatePropagation()},_loadPreviewImage:function(e){var t=new Image,r=this;t.onerror=function(){var e=r._form.one("."+n.IMAGEPREVIEW);e.setStyles({display:"none"}),r.getDialogue().centerDialogue()},t.onload=function(){var e,t,i,o,u;r._rawImageDimensions={width:this.width,height:this.height},e=r._form.one("."+n.INPUTWIDTH),t=e.get("value"),t===""&&(e.set("value",this.width),t=""+this.width),e=r._form.one("."+n.INPUTHEIGHT),i=e.get("value"),i===""&&(e.set("value",this.height),i=""+this.height),e=r._form.one("."+n.IMAGEPREVIEW),e.setAttribute("src",this.src),e.setStyles({display:"inline"}),e=r._form.one("."+n.INPUTCONSTRAIN),t.match(s.ISPERCENT)&&i.match(s.ISPERCENT)?e.set("checked",t===i):(this.width===0&&(this.width=1),this.height===0&&(this.height=1),o=Math.round(1e3*parseInt(t,10)/this.width),u=Math.round(1e3*parseInt(i,10)/this.height),e.set("checked",o===u)),r._autoAdjustSize(r),r.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var t=e.Handlebars.compile(u),r=this.get("host").canShowFilepicker("image"),s=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:n,component:o,showFilepicker:r,alignments:i}));return this._form=s,this._applyImageProperties(this._form),this._form.one("."+n.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+n.IMAGEPRESENTATION).on("change",this._updateWarning,this),this._form.one("."+n.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+n.INPUTWIDTH).on("blur",this._autoAdjustSize,this),this._form.one("."+n.INPUTHEIGHT).on("blur",this._autoAdjustSize,this,!0),this._form.one("."+n.INPUTCONSTRAIN).on("change",function(e){e.target.get("checked")&&this._autoAdjustSize(e)},this),this._form.one("."+n.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+n.INPUTSUBMIT).on("click",this._setImage,this),r&&this._form.one("."+n.IMAGEBROWSER).on("click",function(){this.get("host").showFilepicker("image"
,this._filepickerCallback,this)},this),s},_autoAdjustSize:function(e,t){t=t||!1;var r=this._form.one("."+n.INPUTWIDTH),i="width",o=this._form.one("."+n.INPUTHEIGHT),u="height",a=this._form.one("."+n.INPUTCONSTRAIN),f=r.get("value"),l=o.get("value"),c=this._form.one("."+n.IMAGEPREVIEW),h,p;if(!this._rawImageDimensions)return;f===""&&(f=this._rawImageDimensions[i],r.set("value",f),f=r.get("value")),c.setStyles({width:null,height:null});if(!a.get("checked"))f.match(s.ISPERCENT)?(h=parseInt(f,10),p=this._rawImageDimensions.width/100*h,c.setStyle("width",p+"px")):c.setStyle("width",f+"px"),l.match(s.ISPERCENT)?(h=parseInt(l,10),p=this._rawImageDimensions.height/100*h,c.setStyle("height",p+"px")):c.setStyle("height",l+"px");else{if(t){var d;d=r,r=o,o=d,d=i,i=u,u=d,d=f,f=l,l=d}f.match(s.ISPERCENT)?(l=f,h=parseInt(f,10),p=this._rawImageDimensions.width/100*h,c.setStyle("width",p),p=this._rawImageDimensions.height/100*h,c.setStyle("height",p)):(l=Math.round(f/this._rawImageDimensions[i]*this._rawImageDimensions[u]),t?c.setStyles({width:l,height:f}):c.setStyles({width:f,height:l})),o.set("value",l)}},_filepickerCallback:function(e){if(e.url!==""){var t=this._form.one("."+n.INPUTURL);t.set("value",e.url),this._form.one("."+n.INPUTWIDTH).set("value",""),this._form.one("."+n.INPUTHEIGHT).set("value",""),this._loadPreviewImage(e.url)}},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),r=e.one("."+n.IMAGEPREVIEW),s,o;if(t===!1){r.setStyle("display","none");for(s in i)i[s].isDefault===!0&&(o=i[s].value+":"+i[s].name+";",e.one("."+n.INPUTALIGNMENT).set("value",o));e.one("."+n.INPUTALIGNMENT).getDOMNode().options.remove(i.length-1);return}t.align?(e.one("."+n.INPUTALIGNMENT).set("value",t.align),e.one("."+n.INPUTALIGNMENT).getDOMNode().options.remove(i.length-1)):e.one("."+n.INPUTALIGNMENT).set("value","style:customstyle;"),t.customstyle&&e.one("."+n.INPUTCUSTOMSTYLE).set("value",t.customstyle),t.width&&e.one("."+n.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+n.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+n.INPUTALT).set("value",t.alt),t.src&&(e.one("."+n.INPUTURL).set("value",t.src),this._loadPreviewImage(t.src)),t.presentation&&e.one("."+n.IMAGEPRESENTATION).set("checked","checked"),this._autoAdjustSize()},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null,align:"",presentation:!1},t=this.get("host").getSelectedNodes(),n,r,o,u,a,f,l;t&&(t=t.filter("img"));if(t&&t.size()){f=t.item(0),this._selectedImage=f,u=f.getAttribute("style"),e.customstyle=u,u=u.replace(/ /g,""),r=f.getAttribute("width"),r.match(s.ISPERCENT)||(r=parseInt(r,10)),o=f.getAttribute("height"),o.match(s.ISPERCENT)||(o=parseInt(o,10)),r!==0&&(e.width=r),o!==0&&(e.height=o);for(n in i){a=i[n].value+":"+i[n].name+";";if(u.indexOf(a)!==-1){l="margin:"+i[n].margin+";",l=l.replace(/ /g,"");if(u.indexOf(l)!==-1){e.align=a;break}}}return e.src=f.getAttribute("src"),e.alt=f.getAttribute("alt")||"",e.presentation=f.get("role")==="presentation",e}return this._selectedImage=null,!1},_urlChanged:function(){var e=this._form.one("."+n.INPUTURL);e.get("value")!==""&&this._loadPreviewImage(e.get("value"))},_setImage:function(t){var r=this._form,o=r.one("."+n.INPUTURL).get("value"),u=r.one("."+n.INPUTALT).get("value"),f=r.one("."+n.INPUTWIDTH).get("value"),l=r.one("."+n.INPUTHEIGHT).get("value"),c=r.one("."+n.INPUTALIGNMENT).get("value"),h="",p=r.one("."+n.IMAGEPRESENTATION).get("checked"),d=r.one("."+n.INPUTCONSTRAIN).get("checked"),v,m="",g,y,b=[],w=this.get("host");t.preventDefault();if(this._updateWarning())return;w.focus();if(o!==""){this._selectedImage?w.setSelection(w.getSelectionFromNode(this._selectedImage)):w.setSelection(this._currentSelection);if(c==="style:customstyle;")c="",m=r.one("."+n.INPUTCUSTOMSTYLE).get("value");else for(g in i)y=i[g].value+":"+i[g].name+";",c===y&&(h=" margin: "+i[g].margin+";");d&&b.push(n.RESPONSIVE);if(!f.match(s.ISPERCENT)&&isNaN(parseInt(f,10))){r.one("."+n.INPUTWIDTH).focus();return}if(!l.match(s.ISPERCENT)&&isNaN(parseInt(l,10))){r.one("."+n.INPUTHEIGHT).focus();return}var E=e.Handlebars.compile(a);v=E({url:o,alt:u,width:f,height:l,presentation:p,alignment:c,margin:h,customstyle:m,classlist:b.join(" ")}),this._destroyEditableImg(),this.get("host").insertContentAtFocusPoint(v),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()},_updateWarning:function(){var e=this._form,t=!0,r=e.one("."+n.INPUTALT).get("value"),i=e.one("."+n.IMAGEPRESENTATION).get("checked");return r===""&&!i?(e.one("."+n.IMAGEALTWARNING).setStyle("display","block"),e.one("."+n.INPUTALT).setAttribute("aria-invalid",!0),e.one("."+n.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),t=!0):(e.one("."+n.IMAGEALTWARNING).setStyle("display","none"),e.one("."+n.INPUTALT).setAttribute("aria-invalid",!1),e.one("."+n.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),t=!1),this.getDialogue().centerDialogue(),t}})},"@VERSION@",{requires:["moodle-editor_atto-rangy","moodle-editor_atto-plugin","resize","resize-plugin","dd-plugin"]});
